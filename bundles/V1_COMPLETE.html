<!-------------------------ü¶© Data ü¶©------------------------>

<!-- üíº Offices üíº -->
<script type="text/javascript">
  const CRUCIAL_PATHS = [
    'country.currency.ISO_4217',
    'club.plan_id',
    'country.lang.ISO_639',
    'country.ISO_3166_1_alfa_2'
  ];

  const MAX_RETRIES = 10;
  const RETRY_INTERVAL = 200; // ms
  const WAIT_TIME_AFTER_FAILURE = 30000; // 30 seconds

  document.addEventListener("DOMContentLoaded", initCreatifornia);
  document.addEventListener("get-creatifornia", initCreatifornia);

  function initCreatifornia() {
    const authToken = localStorage.getItem("AuthToken");
    if (!authToken) return;

    xano.setAuthToken(authToken);
    xano.get('/offices').then(response => {
      if (response && response.body) {
        localStorage.setItem("offices", JSON.stringify(response.body));
        validateCrucialPaths(response.body, 0);
      }
    }).catch(error => {
      console.error("‚ùå Error al obtener datos de Creatifornia:", error);
    });
  }

  function validateCrucialPaths(data, attempt) {
    if (allCrucialPathsExist(data)) {
      console.log("üíº Offices");
      document.dispatchEvent(new Event("creatifornia-ready"));
      return;
    }

    if (attempt < MAX_RETRIES) {
      setTimeout(() => {
        const storedData = JSON.parse(localStorage.getItem("offices") || "{}");
        validateCrucialPaths(storedData, attempt + 1);
      }, RETRY_INTERVAL);
    } else {
      console.warn("‚ö†Ô∏è Crucial paths no encontrados tras m√∫ltiples intentos. Esperando 30 segundos para reintentar.");
      setTimeout(() => {
        document.dispatchEvent(new Event("get-creatifornia"));
      }, WAIT_TIME_AFTER_FAILURE);
    }
  }

  function allCrucialPathsExist(data) {
    return CRUCIAL_PATHS.every(path => {
      const value = getNestedValue(data, path);
      return value !== undefined && value !== null;
    });
  }

  function getNestedValue(obj, path) {
    return path.split('.').reduce((acc, key) => {
      return acc && acc[key] !== undefined ? acc[key] : undefined;
    }, obj);
  }
</script>

<!-- ü¶ß Options ü¶ß -->
<script type="text/javascript">
document.addEventListener("creatifornia-ready", initOptions);

// Versi√≥n actual del sistema - ACTUALIZAR CON CAMBIOS
const CURRENT_SYSTEM_VERSION = 'v1.0';

function initOptions() {
    const authToken = localStorage.getItem("AuthToken");
    const existingOptions = localStorage.getItem("options");
    
    // Verificar par√°metro ?update en URL
    const forceRefresh = new URLSearchParams(window.location.search).has('update');
    
    if (forceRefresh && existingOptions) {
        console.log("ü¶ß Options by URL");
        localStorage.removeItem("options");
    }
    
    // 1. Validar opciones existentes
    if (existingOptions && !forceRefresh) {
        try {
            const parsedOptions = JSON.parse(existingOptions);
            if (parsedOptions.version === CURRENT_SYSTEM_VERSION) {
                document.dispatchEvent(new Event("options-ready"));
                console.log("ü¶ß Options");
                return;
            }
            localStorage.removeItem("options");
        } catch (e) {
            console.warn("Corrupted options, refreshing...");
            localStorage.removeItem("options");
        }
    }

    // 2. Descargar nuevas opciones si hay token
    if (authToken) {
        xano.setAuthToken(authToken);
        
        // Funci√≥n corregida para aplanar datos
        const transformStructure = (optionsArray) => {
            const result = {};
            
            optionsArray.forEach(item => {
                Object.entries(item).forEach(([key, value]) => {
                    // Manejar arrays (categor√≠as con opciones)
                    if (Array.isArray(value)) {
                        const optionsObj = value.find(i => i.options);
                        const messageObj = value.find(i => i.message);
                        
                        result[key] = {
                            options: optionsObj?.options || [],
                            message: messageObj?.message || 'Elige una opci√≥n'
                        };
                    } 
                    // Manejar objetos simples
                    else if (typeof value === 'object' && value !== null) {
                        result[key] = value;
                    }
                });
            });
            
            return result;
        };

        // Funci√≥n segura para obtener valores desde localStorage.offices
        function getOffices(path) {
            try {
                const data = JSON.parse(localStorage.getItem("offices") || "{}");
                return path.split('.').reduce((acc, key) => acc?.[key], data);
            } catch (e) {
                console.error("‚ùå Error parsing offices from localStorage:", e);
                return null;
            }
        }

        (async () => {
            try {
                // Usar getOffices para acceso seguro
                const lang = getOffices('country.lang.ISO_639');
                const country = getOffices('country.ISO_3166_1_alfa_2');
                
                const response = await xano.get(`/options?lang=${lang}&country=${country}`);
                
                if (response?.body && Array.isArray(response.body)) {
                    const finalOptions = {
                        ...transformStructure(response.body),
                        version: CURRENT_SYSTEM_VERSION
                    };
                    
                    localStorage.setItem("options", JSON.stringify(finalOptions));
                    console.log(`ü¶ß Options ${CURRENT_SYSTEM_VERSION}`, finalOptions);
                    document.dispatchEvent(new Event("options-ready"));
                }
            } catch (error) {
                console.error("‚ùå Options error:", error);
            }
        })();
    }
}
</script>

<!-- üåä Dynamic üåä -->
<script type="text/javascript">
    
document.addEventListener("creatifornia-ready", initDynamicText);

// Versi√≥n actual del sistema
const CURRENT_DYNAMIC_TEXT_VERSION = 'v1.0';

function initDynamicText() {
    const authToken = localStorage.getItem("AuthToken");
    const existingText = localStorage.getItem("dynamic");
    
    // Verificar par√°metro ?update
    const forceRefresh = new URLSearchParams(window.location.search).has('update');
    
    if (forceRefresh && existingText) {
        console.log("üåä Dynamic by URL");
        localStorage.removeItem("dynamic");
    }
    
    // 1. Validar texto existente
    if (existingText && !forceRefresh) {
        try {
            const parsedText = JSON.parse(existingText);
            if (parsedText.version === CURRENT_DYNAMIC_TEXT_VERSION) {
                document.dispatchEvent(new Event("dynamic-ready"));
                console.log("üåä Dynamic");
                return;
            }
            localStorage.removeItem("dynamic");
        } catch (e) {
            console.warn("Corrupted dynamic, refreshing...");
            localStorage.removeItem("dynamic");
        }
    }

    // 2. Descargar nuevo texto si hay token
    if (authToken) {
        xano.setAuthToken(authToken);

        // Funci√≥n segura para obtener valores desde localStorage.offices
        function getOffices(path) {
            try {
                const data = JSON.parse(localStorage.getItem("offices") || "{}");
                return path.split('.').reduce((acc, key) => acc?.[key], data);
            } catch (e) {
                console.error("‚ùå Error parsing offices from localStorage:", e);
                return null;
            }
        }
        
        (async () => {
            try {
                // Obtener par√°metros directamente desde getOffices
                const lang = getOffices('country.lang.ISO_639');
                const country = getOffices('country.ISO_3166_1_alfa_2');
                
                const response = await xano.get(`/dynamic?lang=${lang}&country=${country}`);
                
                if (response?.body) {
                    const flattenedText = response.body.flat(Infinity).reduce((acc, item) => {
                        if (typeof item === 'object' && item !== null) {
                            Object.entries(item).forEach(([key, value]) => {
                                if (typeof value === 'string' || typeof value === 'number') {
                                    acc[key] = value;
                                }
                            });
                        }
                        return acc;
                    }, { version: CURRENT_DYNAMIC_TEXT_VERSION });
                    
                    localStorage.setItem("dynamic", JSON.stringify(flattenedText));
                    console.log(`üåä Dynamic ${CURRENT_DYNAMIC_TEXT_VERSION}`);
                    document.dispatchEvent(new Event("dynamic-ready"));
                }
            } catch (error) {
                console.error("‚ùå dynamic error:", error);
            }
        })();
    }
}
</script>

<!-- üêé DataAPI üêé -->
  <script type="text/javascript">
  document.addEventListener("creatifornia-ready", fetchData);

  const CURRENT_DATA_VERSION = 'v1.0';

  function fetchData() {
    (async () => {
      const authToken = localStorage.getItem("AuthToken");
      const existingData = localStorage.getItem("data");
      
      // Verificar par√°metro de actualizaci√≥n
      const urlParams = new URLSearchParams(window.location.search);
      const forceRefresh = urlParams.has('update');
      
      if (forceRefresh && existingData) {
        console.log("üêé Data API by URL");
        localStorage.removeItem("data");
      }
      
      // Verificar cache
      if (existingData && !forceRefresh) {
        try {
          const parsedData = JSON.parse(existingData);
          if (parsedData.version === CURRENT_DATA_VERSION) {
            document.dispatchEvent(new Event("data-api-ready")); 
            console.log("üêé Data API");
            return;
          }
          localStorage.removeItem("data");
        } catch (e) {
          console.warn("Corrupted data, refreshing...");
          localStorage.removeItem("data");
        }
      }

      if (authToken) {
        xano.setAuthToken(authToken);
        
        try {
          const response = await xano.get('/data');
          if (response?.body) {
            // Funci√≥n para limpiar la estructura
            const cleanStructure = (data) => {
              if (Array.isArray(data)) {
                // Convertir array a objeto manteniendo las claves originales
                let result = {};
                data.forEach(item => {
                  if (typeof item === 'object' && item !== null) {
                    Object.keys(item).forEach(key => {
                      result[key] = cleanStructure(item[key]);
                    });
                  }
                });
                return result;
              } else if (typeof data === 'object' && data !== null) {
                let result = {};
                Object.keys(data).forEach(key => {
                  result[key] = cleanStructure(data[key]);
                });
                return result;
              }
              return data;
            };
            
            const cleanedData = cleanStructure(response.body);
            cleanedData.version = CURRENT_DATA_VERSION;
            
            localStorage.setItem("data", JSON.stringify(cleanedData));
            console.log(`üêé Data API (${CURRENT_DATA_VERSION})`);
            document.dispatchEvent(new Event("data-api-ready"));
          }
        } catch (error) {
          console.error("‚ùå Data fetch error:", error);
        }
      }
    })();
  }
</script>

<!-- üåé Translate üåé -->
<script type="text/javascript">
document.addEventListener("creatifornia-ready", initTranslate);

// Versi√≥n actual del sistema - ACTUALIZAR CON CAMBIOS
const CURRENT_TRANSLATE_VERSION = 'v1.0';

function initTranslate() {
    // Funci√≥n segura para obtener valores desde localStorage.offices
    function getOffices(path) {
        try {
            const data = JSON.parse(localStorage.getItem("offices") || "{}");
            return path.split('.').reduce((acc, key) => acc?.[key], data);
        } catch (e) {
            console.error("‚ùå Error parsing offices from localStorage:", e);
            return null;
        }
    }

    (async () => {
        // 1. Obtener idioma directamente de Offices
        const lang = getOffices('country.lang.ISO_639');
        
        if (lang === 'es') {
            document.dispatchEvent(new CustomEvent("translate-not-needed", {
                detail: { lang }
            }));
            return;
        }

        const authToken = localStorage.getItem("AuthToken");
        const existingText = localStorage.getItem("translate");
        
        // Verificar par√°metro de actualizaci√≥n
        const forceRefresh = new URLSearchParams(window.location.search).has('update');
        
        if (forceRefresh && existingText) {
            console.log("üåé Translate Data by URL");
            localStorage.removeItem("translate");
        }
        
        // 2. Verificar si existe texto con versi√≥n actual
        if (existingText && !forceRefresh) {
            try {
                const parsedText = JSON.parse(existingText);
                
                if (parsedText.version === CURRENT_TRANSLATE_VERSION) {
                    document.dispatchEvent(new Event("translate-data-ready")); 
                    console.log("üåé Translate Data");
                    return;
                }
                
                localStorage.removeItem("translate");
            } catch (e) {
                console.warn("Corrupted translate, refreshing...");
                localStorage.removeItem("translate");
            }
        }

        if (authToken) {
            xano.setAuthToken(authToken);
            
            try {
                // Obtener pa√≠s directamente de Offices
                const country = getOffices('country.ISO_3166_1_alfa_2');
                const apiUrl = `/translate?lang=${lang}&country=${country}`;
                
                const response = await xano.get(apiUrl);
                if (response?.body) {
                    const finalText = response.body.flat(Infinity).reduce((acc, item) => {
                        if (typeof item === 'object' && item !== null) {
                            Object.entries(item).forEach(([key, value]) => {
                                if (typeof value === 'string' || typeof value === 'number') {
                                    acc[key] = value;
                                }
                            });
                        }
                        return acc;
                    }, { version: CURRENT_TRANSLATE_VERSION });
                    
                    localStorage.setItem("translate", JSON.stringify(finalText));
                    console.log(`üåé Translate Data ${CURRENT_TRANSLATE_VERSION}`);
                    document.dispatchEvent(new Event("translate-data-ready"));
                }
            } catch (error) {
                console.error("‚ùå translate error:", error);
            }
        }
    })();
}
</script>

<!--‚è∞ Events: data-ready ‚è∞ --> 
<script> //a√±adir dvento de actualizar cache si es necesario
  (function() {
    const REQUIRED_EVENTS = [
      "options-ready",
      "dynamic-ready",
      "data-api-ready"
    ];

    let receivedEvents = new Set();
    let readyTimer = null;

    function checkAllReady() {
      if (REQUIRED_EVENTS.every(event => receivedEvents.has(event))) {
        clearTimeout(readyTimer); // Cancelar timer previo si existe
        readyTimer = setTimeout(() => {
          console.log("‚è∞ü¶©");
          document.dispatchEvent(new Event("data-ready"));
          resetCoordinator();
        }, 300); 
      }
    }

    function resetCoordinator() {
      receivedEvents.clear();
    }

    REQUIRED_EVENTS.forEach(eventName => {
      document.addEventListener(eventName, () => {
        if (!receivedEvents.has(eventName)) {
          receivedEvents.add(eventName);
          checkAllReady();
        }
      });
    });
  })();
</script> 



<!------------------------üê≥ Fill  üê≥ ------------------------>

<!-- ü¶® Text ü¶®  -->
<script type="text/javascript">
document.addEventListener("data-ready", fillTextFromCache);

function fillTextFromCache() {
    const elements = document.querySelectorAll('[fill-text-key]');
    let elementsProcessed = 0;
    const totalElements = elements.length;

    if (totalElements === 0) {
        dispatchTextReady();
        return;
    }

    elements.forEach(element => {
        const cacheKey = element.getAttribute('fill-text-key'); 
        const path = element.getAttribute('fill-text-path');
        
        if (!cacheKey || !path) {
            checkAllElementsProcessed();
            return;
        }

        const value = getFromCache(cacheKey, path);

        if (value !== null && value !== undefined) {
            element.textContent = value;
        }

        checkAllElementsProcessed();
    });

    function getFromCache(key, path) {
        try {
            const data = JSON.parse(localStorage.getItem(key) || "{}");
            return path.split('.').reduce((acc, key) => acc?.[key], data);
        } catch (e) {
            console.error(`‚ùå Error accessing localStorage[${key}]:`, e);
            return null;
        }
    }

    function checkAllElementsProcessed() {
        elementsProcessed++;
        if (elementsProcessed === totalElements) {
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    dispatchTextReady();
                });
            });
        }
    }

    function dispatchTextReady() {
        const event = new CustomEvent('fill-text-ready', {
            bubbles: true,
            cancelable: true,
            detail: { 
                elementsCount: totalElements,
                timestamp: performance.now()
            }
        });
        document.dispatchEvent(event);
    }
}
</script>

<!-- üìÆ Inputs üìÆ  -->
<script type="text/javascript">
document.addEventListener("data-ready", fillInputsFromCache);

function fillInputsFromCache() {
    const inputs = document.querySelectorAll('[fill-inputs-key]');
    let inputsProcessed = 0;
    const totalInputs = inputs.length;

    if (totalInputs === 0) {
        dispatchInputsReady();
        return;
    }

    inputs.forEach(input => {
        const cacheKey = input.getAttribute('fill-inputs-key'); // 'offices', 'translate', 'dynamic'
        const path = input.getAttribute('fill-inputs-path');

        if (!cacheKey || !path) {
            checkAllInputsProcessed();
            return;
        }

        const value = getFromCache(cacheKey, path);

        if (value !== null && value !== undefined) {
            if (input.type === 'checkbox') {
                input.checked = Boolean(value);
            } else if (input.type === 'radio') {
                if (input.value === value.toString()) input.checked = true;
            } else if (input.tagName === 'SELECT' && input.multiple && Array.isArray(value)) {
                Array.from(input.options).forEach(opt => {
                    opt.selected = value.includes(opt.value);
                });
            } else {
                input.value = value;
            }

            // Set placeholder only if not already defined
            if (!input.placeholder && typeof value === 'string') {
                input.placeholder = value;
            }
        }

        checkAllInputsProcessed();
    });

    function getFromCache(key, path) {
        try {
            const data = JSON.parse(localStorage.getItem(key) || "{}");
            return path.split('.').reduce((acc, key) => acc?.[key], data);
        } catch (e) {
            console.error(`‚ùå Error accessing localStorage[${key}]:`, e);
            return null;
        }
    }

    function checkAllInputsProcessed() {
        inputsProcessed++;
        if (inputsProcessed === totalInputs) {
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    dispatchInputsReady();
                });
            });
        }
    }

    function dispatchInputsReady() {
        const event = new CustomEvent('fill-inputs-ready', {
            bubbles: true,
            cancelable: true,
            detail: {
                inputsCount: totalInputs,
                timestamp: performance.now()
            }
        });
        document.dispatchEvent(event);
    }
}
</script>

<!-- üêì Direct üêì -->
<script>
document.addEventListener('data-ready', () => {
  const elements = document.querySelectorAll('[cf-direct-input]');
  
  // Procesar elementos si existen
  elements.forEach(el => {
    el.value = el.getAttribute('cf-direct-input');
    el.dispatchEvent(new Event('input', {bubbles: true}));
  });

  // Disparar el evento INCLUSO si no hay elementos
  document.dispatchEvent(new Event('direct-inputs-ready'));
  
});
</script>

<!--‚è∞ Events: fill-ready ‚è∞ -->
<script>
  (function() {
    const REQUIRED_EVENTS = [
      "direct-inputs-ready",
      "fill-inputs-ready",
      "fill-text-ready"
     
                            ];

    let receivedEvents = new Set();

    function checkAllReady() {
      if (REQUIRED_EVENTS.every(event => receivedEvents.has(event))) {
        console.log("‚è∞üê≥");
        document.dispatchEvent(new Event("fill-ready"));
        resetCoordinator(); // ‚¨ÖÔ∏è Reinicio autom√°tico justo despu√©s
      }
    }

    function resetCoordinator() {
      receivedEvents.clear();
    }

    // Escucha todos los eventos requeridos
    REQUIRED_EVENTS.forEach(eventName => {
      document.addEventListener(eventName, () => {
        if (!receivedEvents.has(eventName)) {
          receivedEvents.add(eventName);
          checkAllReady();
        }
      });
    });
  })();
</script> 



<!------------------------üß± Components üß±------------------------>

<!-- ü¶ß Options ü¶ß -->
<script>
document.addEventListener("data-ready", buildOptionGroups);


function buildOptionGroups() {
  const containers = document.querySelectorAll("[cf-options-build]");

  containers.forEach(container => {
    // Configuraci√≥n b√°sica
    const componentId = container.getAttribute("cf-options-build");
    const inputType = container.getAttribute("cf-options-type") || "checkbox";
    const key = container.getAttribute("cf-options-key");
    const path = `${container.getAttribute("cf-options-path")}.options`;
    const jsonPath = container.getAttribute("cf-options-path");
    const activeClass = container.getAttribute("cf-options-active") || "is-active-inputactive";
    const limit = container.getAttribute("cf-checkbox-limit");
    const cfRequired = container.getAttribute("cf-required");
    const requiredPath = `${key}.${container.getAttribute("cf-options-path")}.message`;
    const valueKey = container.getAttribute("cf-value-key") || "value";
    const tagKey = container.getAttribute("cf-tag-key") || "tag";
    const labelKey = container.getAttribute("cf-label-key") || "label";
    const submitPath = container.getAttribute("submit-json-path");  
    
    // Manejo de mensajes requeridos
    let cfMessage = "Select an option";
    if (requiredPath) {
      const [lsKey, ...pathParts] = requiredPath.split(".");
      if (lsKey && pathParts.length > 0) {
        try {
          const stored = JSON.parse(localStorage.getItem(lsKey));
          cfMessage = pathParts.reduce((acc, part) => acc?.[part], stored) || "Select one option";
        } catch {
          cfMessage = "Select one option";
        }
      }
    }

    // Configuraci√≥n de relaciones parent-child
    const isParent = container.hasAttribute("cf-options-parent");
    const isChild = container.hasAttribute("cf-options-child");
    const childGroupName = container.getAttribute("cf-options-child") || "";
    const targetValue = container.getAttribute("cf-options-target") || "";

    // Campos de datos (sin 'class')
    const fields = {
      value: valueKey, 
      label: labelKey,
      id: "id",
      tag: tagKey
      
    };

    // Obtener plantilla
    const template = document.querySelector(`[data-options-component="${componentId}"]`);
    if (!template) {
      console.error(`Template no encontrado: data-options-component="${componentId}"`);
      return;
    }

    const baseGroup = template.querySelector("[data-options-group]");
    const fieldTemplate = template.querySelector("[data-options-field]");

    if (!baseGroup || !fieldTemplate) {
      console.error("La plantilla necesita [data-options-group] y [data-options-field]");
      return;
    }

    // Obtener datos
    let data;
    try {
      data = JSON.parse(localStorage.getItem(key));
    } catch {
      console.warn(`Datos inv√°lidos en localStorage["${key}"]`);
      return;
    }

    const list = path.split('.').reduce((acc, prop) => acc?.[prop], data);
    if (!Array.isArray(list) || list.length === 0) {
      console.warn(`Lista no encontrada en ${key} ‚Üí ${path}`);
      return;
    }

    // Clonar grupo base
    const groupClone = baseGroup.cloneNode(false);
    groupClone.setAttribute("data-options-group", "");
    groupClone.setAttribute("group-id", jsonPath);

    // Configurar target si existe
    if (targetValue) {
      container.setAttribute("cf-options-target", targetValue);
    }

    // Crear input hidden con soporte para ID
    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.setAttribute("cf-json-path", submitPath || jsonPath);
    hiddenInput.setAttribute("name", path);
    hiddenInput.setAttribute("data-required-message", cfMessage);
    
    if (inputType === "checkbox" && limit) {
      hiddenInput.setAttribute("cf-checkbox-limit", limit);
    }

    if (isChild) {
      hiddenInput.setAttribute("cf-options-display-input", childGroupName);
    }

    if (isParent && cfRequired === "true") {
      hiddenInput.setAttribute("data-required", "");
    }

    hiddenInput.value = inputType === "checkbox" ? "[]" : "";
    groupClone.appendChild(hiddenInput);

    // Procesar cada opci√≥n
    list.forEach(item => {
      const field = fieldTemplate.cloneNode(true);
      field.classList.remove(activeClass);

      const input = field.querySelector("[data-options-button]");
      const label = field.querySelector("[data-options-label]");
      const tagElement = field.querySelector("[label-tag]");

      if (!input || !label) return;

      input.type = inputType;
      input.setAttribute("cf-options-value", item[fields.value]);
      input.setAttribute("cf-options-label", item[fields.label]);
      
      // Asegurar que el ID se env√≠a correctamente
      if (item[fields.id]) {
        input.setAttribute("cf-options-id", item[fields.id]);
      }
      
      input.setAttribute("cf-options-path", submitPath || jsonPath);
      input.setAttribute("cf-options-active", activeClass);
      input.setAttribute("name", inputType === "radio" ? path : "");

      if (isParent) {
        input.setAttribute("cf-options-parent", container.getAttribute("cf-options-parent"));
      }

      label.textContent = item[fields.label];
      
      // Manejar tag si existe
      if (tagElement) {
        const tagValue = item[fields.tag]?.trim() || "";
        tagElement.textContent = tagValue;
        tagElement.style.display = tagValue ? "block" : "none";
      }

      groupClone.appendChild(field);
    });

    container.appendChild(groupClone);
  });

  // Ocultar plantillas originales
  document.querySelectorAll("[data-options-component]").forEach(el => {
    el.style.display = "none";
  });
  
  document.dispatchEvent(new Event("options-builder-ready"));
}
</script>

<!-- üß± Keywords üß± -->
<script>
document.addEventListener("data-ready", buildKeywords);

function getCache(key, path) {
    try {
        const data = JSON.parse(localStorage.getItem(key));
        return path.split('.').reduce((acc, part) => acc?.[part], data);
    } catch (e) {
        console.warn(`‚ö†Ô∏è Error accediendo a ${key}.${path}`);
        return undefined;
    }
}

function buildKeywords() {
    const containers = document.querySelectorAll("[cf-keywords-build]");

    containers.forEach(container => {
        const componentId = container.getAttribute("cf-keywords-build");
        const formPath = container.getAttribute("form-path");
        const keywordsLimit = container.getAttribute("keywords-limit");
        const maxLength = container.getAttribute("maxlength") || "256";
        const cfRequired = container.getAttribute("cf-required");
        const customMessage = getCache('dynamic', 'keywords');
        const child = container.getAttribute("cf-child");
        const target = container.getAttribute("cf-target");
        const template = document.getElementById(componentId);

        if (!template) {
            console.error(`‚ùå No se encontr√≥ template con id="${componentId}"`);
            return;
        }

        // CORRECCI√ìN 1: Asegurar que el contenedor principal sea visible
        container.style.display = "block";
        container.style.opacity = "1";
        container.style.visibility = "visible";

        // Clonar el template conservando todas las clases y estructura
        const clone = template.cloneNode(true);
        clone.removeAttribute("id");
        
        // CORRECCI√ìN 2: Eliminar display:none del clon
        clone.style.display = "block";
        container.appendChild(clone);

        // Obtener elementos del clon
        const wordsGroup = clone.querySelector("[words-group]");
        const wordButtonTemplate = wordsGroup.querySelector("[word-button]").cloneNode(true);
        const textFieldContainer = clone.querySelector("[text-field-container]");
        const input = textFieldContainer.querySelector("[keywords-input]");
        const addButton = textFieldContainer.querySelector("[add-button]");

        // Eliminar el ejemplo del template clonado
        wordsGroup.innerHTML = "";

        // Configurar input
        input.setAttribute("maxlength", maxLength);

        // Crear input hidden para almacenar las palabras
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.setAttribute("cf-json-path", formPath);
        hiddenInput.setAttribute("name", formPath);
        hiddenInput.setAttribute("data-required-message", customMessage);
        hiddenInput.setAttribute("cf-options-child", child);
        hiddenInput.setAttribute("cf-options-target", target);
        hiddenInput.value = "[]";
        
        if (cfRequired === "true") {
            hiddenInput.setAttribute("data-required", "");  
        }
        container.insertBefore(hiddenInput, clone);

        // Estado inicial - array vac√≠o
        let keywords = [];

        // Funci√≥n para actualizar el input hidden y la vista
        const updateKeywords = () => {
            hiddenInput.value = JSON.stringify(keywords);
            
            // Actualizar vista
            wordsGroup.innerHTML = "";
            keywords.forEach((keyword, index) => {
                const keywordElement = wordButtonTemplate.cloneNode(true);
                keywordElement.querySelector("[generated-keyword]").textContent = keyword;
                
                keywordElement.addEventListener("click", (e) => {
                    e.preventDefault();
                    keywords = keywords.filter((_, i) => i !== index);
                    updateKeywords();
                });
                
                wordsGroup.appendChild(keywordElement);
            });
        };

        // Funci√≥n para agregar nueva palabra
        const addKeyword = () => {
            const newKeyword = input.value.trim();
            
            if (!newKeyword) return;
            
            if (keywordsLimit && keywords.length >= parseInt(keywordsLimit)) {
                showErrorModal(`M√°ximo ${keywordsLimit} palabras permitidas`);
                return;
            }
            
            if (keywords.includes(newKeyword)) {
                showErrorModal("Esta palabra ya fue agregada");
                return;
            }
            
            keywords.push(newKeyword);
            input.value = "";
            updateKeywords();
        };

        // Event listeners
        addButton.addEventListener("click", (e) => {
            e.preventDefault();
            addKeyword();
        });
        
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                addKeyword();
            }
        });

        // Ocultar template original
        template.style.display = "none";
        
        // Inicializar con vista vac√≠a
        updateKeywords();
    });

    document.dispatchEvent(new Event("keywords-builder-ready"));
}
</script>

<!-- üí∞ Currency üí∞ -->
<script>    
document.addEventListener("data-ready", function() {
  // Funci√≥n auxiliar para obtener datos desde localStorage
  function getCache(key, path) {
    try {
      const data = JSON.parse(localStorage.getItem(key));
      return path.split('.').reduce((acc, part) => acc?.[part], data);
    } catch (e) {
      console.warn(`‚ö†Ô∏è Error accediendo a ${key}.${path}`);
      return undefined;
    }
  }

  // Verificar si la moneda usa centavos
  const currencyCents = !!getCache('offices', 'country.currency.cents');
  if (!currencyCents) {
    document.dispatchEvent(new Event('currency-cents'));
    return;
  }

  const containers = document.querySelectorAll("[cf-currency-build]");
  containers.forEach(container => {
    const visibleInput = container.querySelector("input[type='text']");
    if (!visibleInput) return;

    const currency = getCache('offices', 'country.currency.ISO_4217');
    const symbol = getCache('offices', 'country.currency.symbol');
    const minCurrency = parseFloat(container.getAttribute("cf-min-currency")) || 0;
    const maxCurrency = parseFloat(container.getAttribute("cf-max-currency")) || Number.MAX_SAFE_INTEGER;
    const jsonPath = container.getAttribute("cf-currency-path");
    const cfRequired = container.getAttribute("cf-required") === 'true';

    // Obtener mensajes desde cache
    const requiredMessage = getCache('offices', 'country.currency.required_message');
    const minimumRawMessage = getCache('offices', 'country.currency.minimum_message');
    const maximumRawMessage = getCache('offices', 'country.currency.max_message');

    const minimumMessage = minimumRawMessage
      ? `${minimumRawMessage} ${symbol}${(minCurrency / 100).toFixed(2)}`
      : `El monto m√≠nimo es ${symbol}${(minCurrency / 100).toFixed(2)}`;

    const maxMessage = maximumRawMessage
      ? `${maximumRawMessage} ${symbol}${(maxCurrency / 100).toFixed(2)}`
      : `El monto m√°ximo es ${symbol}${(maxCurrency / 100).toFixed(2)}`;

    // Actualizar visualizaci√≥n de currency
    const currencyDisplay = container.querySelector('[this-is-currency]');
    if (currencyDisplay) {
      currencyDisplay.textContent = currency;
    }

    // Create hidden input with validation attributes
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = jsonPath;
    hiddenInput.setAttribute('cf-json-path', jsonPath);
    hiddenInput.setAttribute('data-min-amount', minCurrency);
    hiddenInput.setAttribute('data-max-amount', maxCurrency);
    hiddenInput.setAttribute('data-currency-symbol', symbol);
    hiddenInput.setAttribute('data-currency-code', currency);
    hiddenInput.setAttribute('data-min-message', minimumMessage);
    hiddenInput.setAttribute('data-max-message', maxMessage);
    
    if (cfRequired && requiredMessage) {
      hiddenInput.setAttribute('data-required', '');
      hiddenInput.setAttribute('data-required-message', requiredMessage);
    }
    
    container.insertBefore(hiddenInput, visibleInput.nextSibling);

    let currentValue = 0;
    let lastValidValue = '';

    // Input validation function
    const validateInput = (value) => {
      const validChars = /^[\d.,]*$/;
      const decimalSeparators = value.match(/[.,]/g) || [];
      
      if (decimalSeparators.length > 1) return false;
      
      if (value.includes('.') || value.includes(',')) {
        const parts = value.split(/[.,]/);
        if (parts[1] && parts[1].length > 2) return false;
      }
      
      return validChars.test(value);
    };

    // Format display value
    const formatDisplayValue = (value) => {
      return `${symbol}${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
    };

    // Format full display value with currency code
    const formatDisplayValueFull = (value) => {
      return `${symbol}${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ${currency}`;
    };

    // Update currency values
    const updateCurrencyValue = (value) => {
      const numericValue = parseFloat(value.replace(/,/g, '.')) || 0;
      currentValue = numericValue;
      
      hiddenInput.value = JSON.stringify({
        unit_amount: Math.round(numericValue * 100),
        display_value: formatDisplayValue(numericValue),
        display_value_full: formatDisplayValueFull(numericValue),
        currency: currency,
        symbol: symbol,
        raw_value: numericValue
      });
    };

    // Input event handler
    visibleInput.addEventListener('input', (e) => {
      const value = e.target.value;
      
      if (!validateInput(value)) {
        visibleInput.classList.add('invalid');
        setTimeout(() => visibleInput.classList.remove('invalid'), 500);
        e.target.value = lastValidValue;
        return;
      }
      
      lastValidValue = value;
      updateCurrencyValue(value);
    });

    // Blur event handler
    visibleInput.addEventListener('blur', () => {
      if (currentValue < (minCurrency/100)) {
        visibleInput.value = formatDisplayValue(minCurrency/100);
        updateCurrencyValue((minCurrency/100).toString());
        showErrorModal(minimumMessage);
      } else if (currentValue > (maxCurrency/100)) {
        visibleInput.value = formatDisplayValue(maxCurrency/100);
        updateCurrencyValue((maxCurrency/100).toString());
        showErrorModal(maxMessage);
      } else {
        visibleInput.value = formatDisplayValue(currentValue);
      }
    });
  });
  
  document.dispatchEvent(new Event('currency-builder-ready'));
});
</script>

<!-- üê∂ FriendlyURL üê∂-->
<script>
document.addEventListener("data-ready", function() {
  // Funci√≥n auxiliar para obtener datos desde localStorage
  function getCache(key, path) {
    try {
      const data = JSON.parse(localStorage.getItem(key));
      return path.split('.').reduce((acc, part) => acc?.[part], data); 
    } catch (e) {
      console.warn(`‚ö†Ô∏è Error accediendo a ${key}.${path}`);
      return undefined;
    }
  }

  const components = document.querySelectorAll('friendly-url');
  
  components.forEach(component => {
    // Obtener atributos del componente
    const jsonPath = component.getAttribute('json-path');
    const messagePath = component.getAttribute('message-path');
    const previewUsernamePath = component.getAttribute('preview-username');
    const previewUrlPath = component.getAttribute('preview-url-friendly');
    const buildMessage = getCache('dynamic', messagePath);
    
    // Obtener elementos internos
    const previewText = component.querySelector('[update-this-with-type-username]');
    const previewUrl = component.querySelector('[update-this-with-type-url]');
    const input = component.querySelector('[text-input-element]');
    
    // Crear input hidden para los datos
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.setAttribute('cf-json-path', jsonPath);    
    hiddenInput.setAttribute('data-required-message', buildMessage);
    hiddenInput.setAttribute('data-required', '');
    hiddenInput.value = JSON.stringify({
      club_name: '',
      url_friendly: ''
    });
    component.insertBefore(hiddenInput, component.firstChild);
    
    // Funci√≥n para validar caracteres (permite espacios)
    function isValidChar(char) {
      return /^[\p{L}\p{N}\s_-]$/u.test(char);
    }
    
    // Funci√≥n para normalizar texto a URL friendly
    function toUrlFriendly(text) {
      return text.trim()
        .toLowerCase()
        .replace(/\s+/g, '-')       // Espacios a guiones
        .replace(/_/g, '-')         // Guiones bajos a guiones
        .normalize('NFD')           // Separar caracteres y acentos
        .replace(/[\u0300-\u036f]/g, '')  // Eliminar diacr√≠ticos
        .replace(/[^\w-]/g, '');    // Eliminar caracteres no alfanum√©ricos
    }
    
    // Funci√≥n para mostrar error (shake)
    function showInputError() {
      input.classList.add('invalid');
      setTimeout(() => input.classList.remove('invalid'), 500);
    }
    
    // Actualizar vista y datos
    function updateUrlPreview(value) {
      // Limitar a 20 caracteres (se aplica directamente al input)
      const normalized = value.trim();
      
      // Aplicar formato especial para el preview de nombre de usuario
      const usernameDisplay = normalized
        .replace(/-/g, '_')  // Reemplazar guiones por guiones bajos
        .replace(/\s+/g, ' '); // Mantener espacios como espacios
      
      const friendly = toUrlFriendly(value);
      
      // Actualizar ambos previews
      if (previewText) {
        previewText.textContent = usernameDisplay || getCache('dynamic', previewUsernamePath);
      }
      
      if (previewUrl) {
        previewUrl.textContent = friendly || getCache('dynamic', previewUrlPath);
      }
      
      // Actualizar hidden input
      hiddenInput.value = JSON.stringify({
        club_name: normalized,
        url_friendly: friendly
      });
    }
    
    // Configurar eventos solo si existe el input
    if (input) {
      let lastValidValue = '';
      const MAX_LENGTH = 20;
      
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        
        // Verificar l√≠mite de caracteres
        if (value.length > MAX_LENGTH) {
          input.value = lastValidValue;
          showInputError();
          return;
        }
        
        // Verificar cada car√°cter nuevo
        const newChar = value.length > lastValidValue.length ? 
                        value.charAt(value.length - 1) : null;
        
        // Si se a√±ade un car√°cter inv√°lido
        if (newChar && !isValidChar(newChar)) {
          // Revertir al √∫ltimo valor v√°lido
          input.value = lastValidValue;
          showInputError();
          return;
        }
        
        // Actualizar el √∫ltimo valor v√°lido
        lastValidValue = value;
        updateUrlPreview(value);
      });
      
      // Manejar eventos de teclado para prevenir caracteres inv√°lidos
      input.addEventListener('keypress', (e) => {
        const char = String.fromCharCode(e.keyCode || e.which);
        
        if (!isValidChar(char)) {
          e.preventDefault();
          showInputError();
        }
      });
      
      // Manejar pegado de texto
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedText = clipboardData.getData('text');
        let validText = lastValidValue;
        
        // Filtrar solo caracteres v√°lidos
        for (const char of pastedText) {
          if (validText.length >= MAX_LENGTH) break;
          if (isValidChar(char)) {
            validText += char;
          }
        }
        
        // Actualizar el valor con solo caracteres v√°lidos
        input.value = validText;
        lastValidValue = validText;
        updateUrlPreview(validText);
        
        // Mostrar error si se trunc√≥ texto
        if (validText.length < (lastValidValue.length + pastedText.length)) {
          showInputError();
        }
      });
      
      // Inicializar con valores actuales
      updateUrlPreview(input.value || '');
      lastValidValue = input.value || '';
    }
  });

  document.dispatchEvent(new Event('url-builder-ready'));
});
</script>

<!-- üêä PlanCalculator üêä-->
<script>
document.addEventListener("data-ready", function () {
  function getCache(key, path) {
    try {
      const data = JSON.parse(localStorage.getItem(key));
      return path.split('.').reduce((acc, part) => acc?.[part], data);
    } catch (e) {
      console.warn(`‚ö†Ô∏è Error accediendo a ${key}.${path}`);
      return undefined;
    }
  }

  const currencyCents = !!getCache('offices', 'country.currency.cents');
  if (!currencyCents) {
    document.dispatchEvent(new Event('plan-calculator-cents'));
    return;
  }

  const planCalculators = document.querySelectorAll('[plan_calculator]');
  const currency = getCache('offices', 'country.currency.ISO_4217');
  const currencySymbol = getCache('offices', 'country.currency.symbol');

  if (!currency) {
    console.error('No se pudo obtener la moneda');
    return;
  }

  planCalculators.forEach(calculator => {
    const planId = calculator.getAttribute('plan_id');
    const limit = parseInt(calculator.getAttribute('limit') || 5);
    const jsonPath = calculator.getAttribute('json-path');
    const clickThisId = calculator.getAttribute('click_this');

    const firstUnit = parseFloat(getCache('data', `scalable_plans.${planId}.${currency}.raw_value_1`));
    const secondUnit = parseFloat(getCache('data', `scalable_plans.${planId}.${currency}.raw_value_second_unit`));

    if (isNaN(firstUnit) || isNaN(secondUnit)) {
      console.error(`Datos incompletos o inv√°lidos para plan ${planId} y moneda ${currency}`);
      return;
    }

    const currencyElement = calculator.querySelector('[currency]');
    const unitElement = calculator.querySelector('[first_unit][second_unit]');
    const symbolElement = calculator.querySelector('[symbol]');
    const StorageUnitElement = calculator.querySelector('[storage_unit]');
    const StorageUnit = StorageUnitElement?.getAttribute('storage_unit');
    const storageBaseElement = calculator.querySelector('[storage_base]');
    const decreaseButton = calculator.querySelector('[cf="disminuir"]')?.closest('a');
    const increaseButton = calculator.querySelector('[cf="aumentar"]')?.closest('a');

    if (currencyElement) currencyElement.textContent = currency;
    const storageBase = parseInt(storageBaseElement?.getAttribute('storage_base'));
    let currentLevel = 1;
    let currentAmount = firstUnit;

    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = jsonPath;
    hiddenInput.setAttribute('cf-json-path', jsonPath);
    hiddenInput.setAttribute('data-required');
    hiddenInput.value = currentLevel;
    calculator.appendChild(hiddenInput);

    function updateUI() {
      if (storageBaseElement) {
        storageBaseElement.textContent = storageBase * currentLevel;
      }
      if (unitElement) {
        unitElement.textContent = `${currencySymbol}${currentAmount.toFixed(2)}`;
      }
      if (symbolElement) {
        symbolElement.textContent = currencySymbol;
      }
      if (StorageUnitElement) {
        StorageUnitElement.textContent = StorageUnit;
      }
      if (decreaseButton) {
        decreaseButton.classList.toggle('inutil', currentLevel === 1);
      }
    }

    if (decreaseButton) {
      decreaseButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentLevel > 1) {
          currentLevel--;
          currentAmount = currentLevel === 1 ? firstUnit : currentAmount - secondUnit;
          updateUI();
        }
      });
    }

    if (increaseButton) {
      increaseButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentLevel < limit) {
          currentLevel++;
          currentAmount = currentAmount + secondUnit;
          updateUI();
        } else if (clickThisId) {
          document.getElementById(clickThisId)?.click();
        }
      });
    }

    updateUI();
  });

  document.dispatchEvent(new Event('plan-calculator-ready'));
});
</script>

<!--‚è∞ Events: inputs-ready‚è∞ -->
<script>
  (function() {
    const REQUIRED_EVENTS = [
      "options-builder-ready",
      "keywords-builder-ready",
      "currency-builder-ready",
      "url-builder-ready",
      "plan-calculator-ready"           
                     ];

    let receivedEvents = new Set();

    function checkAllReady() {
      if (REQUIRED_EVENTS.every(event => receivedEvents.has(event))) {
        console.log("‚è∞üß±");
        document.dispatchEvent(new Event("inputs-ready"));
        resetCoordinator(); // ‚¨ÖÔ∏è Reinicio autom√°tico justo despu√©s
      }
    }

    function resetCoordinator() {
      receivedEvents.clear();
    }

    // Escucha todos los eventos requeridos
    REQUIRED_EVENTS.forEach(eventName => {
      document.addEventListener(eventName, () => {
        if (!receivedEvents.has(eventName)) {
          receivedEvents.add(eventName);
          checkAllReady();
        }
      });
    });
  })();
</script>


<!----------------------- ‚ö° form submit ‚ö° --------------------->
<script>

//‚ö° VALIDACIONES

const ValidationModule = {
  validateRequiredFields(form) {
    const customRequiredFields = form.querySelectorAll('[data-required]');
    let isValid = true;

    customRequiredFields.forEach(field => {
      const rawValue = field.value;
      let isEmpty = false;
      
      if (rawValue === '[]' || rawValue === '{}') {
        isEmpty = true;
      } else {
        try {
          const parsed = JSON.parse(rawValue);
          if (Array.isArray(parsed) && parsed.length === 0) {
            isEmpty = true;
          } else if (typeof parsed === 'object' && Object.keys(parsed).length === 0) {
            isEmpty = true;
          }
        } catch (e) {}
      }
      
      if (!isEmpty) {
        const value = rawValue?.trim();
        isEmpty = !value;
      }

      if (isEmpty) {
        const message = field.getAttribute('data-required-message') || 'Required*';
        showErrorModal(message);
        isValid = false;
      }
    });

    return isValid;
  },

  validateCurrencyFields(form) {
    const currencyFields = form.querySelectorAll('input[type="hidden"][data-min-amount]');
    let isValid = true;

    for (const field of currencyFields) {
      try {
        const value = JSON.parse(field.value);
        const minAmount = parseFloat(field.getAttribute('data-min-amount'));
        const maxAmount = parseFloat(field.getAttribute('data-max-amount'));
        
        if (value.unit_amount < minAmount) {
          showErrorModal(field.getAttribute('data-min-message'));
          isValid = false;
          break;
        }
        
        if (value.unit_amount > maxAmount) {
          showErrorModal(field.getAttribute('data-max-message'));
          isValid = false;
          break;
        }
      } catch (error) {
        console.error('‚ùå Error validando campo monetario:', error);
        isValid = false;
        break;
      }
    }
    
    return isValid;
  }
};


//‚ö° CONSTRUCCI√ìN DE DATOS

const DataBuilderModule = {

  buildFormData(form, formId) {
    const data = { form_id: formId };
    const fields = form.querySelectorAll('[cf-json-path][data-required]');

    fields.forEach(field => {
      const path = field.getAttribute('cf-json-path');
      if (!path) return;

      const value = this.extractFieldValue(field);
      this.setNestedProperty(data, path, value);
    });

    return data;
  },

  extractFieldValue(field) {
    const directInputValue = field.getAttribute('cf-direct-input');
    if (directInputValue !== null) return directInputValue;
    if (field.type === 'checkbox') return field.checked;
    if (field.type === 'radio') return field.checked ? field.value : undefined;
    if (field.tagName === 'SELECT' && field.multiple) {
      return Array.from(field.selectedOptions).map(opt => opt.value);
    }
    return field.value;
  },

  setNestedProperty(obj, path, value) {
    const keys = path.split('.');
    let current = obj;
    keys.forEach((key, index) => {
      if (index === keys.length - 1) {
        current[key] = value;
      } else {
        if (!current[key]) current[key] = {};
        current = current[key];
      }
    });
  }
};

//‚ö° ACTUALIZAR FRONTEND
const FrontendUpdaterModule = {
  /**
   * Actualiza el localStorage basado en los campos del formulario
   * @param {HTMLElement} field - Campo del formulario
   * @param {*} value - Valor a almacenar
   */
  updateLocalStorageFromField(field, value) {
    const lsKey = field.getAttribute('update-local-storage-key');
    const lsPath = field.getAttribute('update-local-storage-path');

    if (!lsKey || !lsPath) return;

    try {
      const storedData = this.getStoredData(lsKey);
      this.updateStoredValue(storedData, lsPath, value);
      localStorage.setItem(lsKey, JSON.stringify(storedData));
      console.log(`üíæ LocalStorage actualizado "${lsKey}" ‚Üí`, storedData);
    } catch (error) {
      console.warn(`‚ö†Ô∏è Error actualizando localStorage para "${lsKey}"`, error);
    }
  },

  /**
   * Obtiene los datos almacenados en localStorage
   * @param {string} key - Clave del localStorage
   * @returns {Object} Datos almacenados
   */
  getStoredData(key) {
    try {
      return JSON.parse(localStorage.getItem(key)) || {};
    } catch (error) {
      console.warn(`‚ö†Ô∏è No se pudo parsear localStorage["${key}"], se usar√° objeto vac√≠o`);
      return {};
    }
  },

  /**
   * Actualiza un valor anidado en el objeto almacenado
   * @param {Object} storedData - Objeto almacenado
   * @param {string} path - Ruta de la propiedad
   * @param {*} value - Nuevo valor
   */
  updateStoredValue(storedData, path, value) {
    const pathKeys = path.split('.');
    let cursor = storedData;
    
    pathKeys.forEach((key, index) => {
      if (index === pathKeys.length - 1) {
        cursor[key] = value;
      } else {
        if (!cursor[key] || typeof cursor[key] !== 'object') {
          cursor[key] = {};
        }
        cursor = cursor[key];
      }
    });
  }
};

//‚ö° ENV√çO Y REINTENTOS

const SubmissionModule = {
  MAX_ATTEMPTS: 8,
  RETRY_DELAY: 22000,

  async submitWithRetry({endpoint, verb, data, form}, attempt = 1) {
    try {
      console.log(`üì§ Env√≠o intento #${attempt} a ${endpoint}`, data);
      if (typeof xano[verb] !== 'function') throw new Error(`‚ùå HTTP verb not supported: ${verb}`);

      const response = await xano[verb](endpoint, data);
      console.log("ü¶ú Response:", response);

      if (localStorage.getItem("uploadcare")) {
        localStorage.removeItem("uploadcare");
        console.log("üßπ Uploadcare removed");
      }

      this.handleResponseEvents(response);

      if (response?.body?.redirect_url) {
        window.location.href = response.body.redirect_url;
        return;
      }

      if (response?.body === "retry") {
        console.warn("‚è≥ Respuesta 'retry' recibida. Reintentando en 22 segundos...");
        if (attempt < this.MAX_ATTEMPTS) {
          setTimeout(() => this.submitWithRetry({endpoint, verb, data, form}, attempt + 1), this.RETRY_DELAY);
        } else {
          showErrorModal("Demasiados intentos. Intenta m√°s tarde.");
        }
        return;
      }

      console.log("‚úÖ Submit");
    } catch (error) {
      console.error(`‚ùå Error en env√≠o a ${endpoint}:`, error);
      showErrorModal("Error al enviar. Intenta m√°s tarde.");
    } finally {
      form.removeAttribute('data-submitting');
    }
  },

  handleResponseEvents(response) {
    if (response?.body?.event) {
      document.dispatchEvent(new CustomEvent(response.body.event, {
        detail: response.body.data || {},
        bubbles: true
      }));
    }

    if (response?.body?.error) {
      showErrorModal(response.body.error);
    }
  }
};


//‚ö° MANEJADOR DE FORMULARIOS

const FormHandlerModule = {
  initialize(form) {
    if (form._submitHandler) {
      form.removeEventListener("submit", form._submitHandler);
    }

    form._submitHandler = this.createSubmitHandler(form);
    form.addEventListener("submit", form._submitHandler);
  },

  createSubmitHandler(form) {
    const formId = form.getAttribute('cf-form-submit') || 'unnamed_form';
    const endpoint = form.getAttribute('cf-endpoint') || '/default_endpoint';
    const verb = (form.getAttribute('cf-verb') || 'patch').toLowerCase();

    return async (e) => {
      e.preventDefault();
      e.stopImmediatePropagation();

      if (!ValidationModule.validateRequiredFields(form)) return;
      if (!ValidationModule.validateCurrencyFields(form)) return;
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      if (form.hasAttribute('data-submitting')) {
        console.warn("‚è∏Ô∏è Formulario ya en proceso de env√≠o");
        return;
      }
      form.setAttribute('data-submitting', 'true');

      const authToken = localStorage.getItem("AuthToken");
      if (!authToken || typeof xano === 'undefined') {
        console.error("‚ùå No AuthToken or Xano instance found");
        form.removeAttribute('data-submitting');
        return;
      }

      xano.setAuthToken(authToken);
      const data = DataBuilderModule.buildFormData(form, formId);
      await SubmissionModule.submitWithRetry({endpoint, verb, data, form});
    };
  }
};


//‚ö° INICIALIZACI√ìN GLOBAL

const InitializationModule = {
  initializeAllForms() {
    document.querySelectorAll('[cf-form-submit]').forEach(form => {
      FormHandlerModule.initialize(form);
    });
    document.dispatchEvent(new Event("submit-ready"));
  },

  updateSingleForm(e) {
    const formId = e.detail?.formIdentifier;
    if (!formId) {
      console.error("‚ùå cf-update-form recibido sin formIdentifier");
      return;
    }
    const form = document.querySelector(`[cf-form-submit="${formId}"]`);
    if (form) FormHandlerModule.initialize(form);
    console.log("‚úÖ Form updated");
  }
};


//‚ö° INICIALIZACI√ìN Y EVENTOS GLOBALES

document.addEventListener("inputs-ready", InitializationModule.initializeAllForms);
document.addEventListener("cf-update-form", InitializationModule.updateSingleForm);
</script>


<!------------------------ü¶â Display ü¶â  ------------------------>

<!-- üåç Translate üåç -->
<script>
document.addEventListener('translate-data-ready', () => {

  // Funci√≥n robusta para obtener datos desde localStorage
  function getCache(key, path = '') {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return undefined;

      const data = JSON.parse(raw);
      if (!path) return data;

      return path.split('.').reduce((acc, part) => acc?.[part], data);
    } catch (e) {
      console.warn(`‚ö†Ô∏è Error accediendo a ${key}${path ? '.' + path : ''}`);
      return undefined;
    }
  }

  // Funci√≥n principal de traducci√≥n
  function applyTranslations() {
    try {
      const translateData = getCache('translate') || {};

      const elements = document.querySelectorAll('[cf]');

      elements.forEach(element => {
        const componentName = element.getAttribute('cf');
        if (translateData?.[componentName]) {
          const hasHTML = element.innerHTML.trim() !== element.textContent.trim();
          element[hasHTML ? 'innerHTML' : 'textContent'] = translateData[componentName];
        }
      });

      console.log("üåç Translation Finished");
    } catch (error) {
      console.error('‚ùå Translation binding error:', error);
    }

    // Emitir evento final
    document.dispatchEvent(new Event('translation-finished'));
  }

  applyTranslations();
});

document.addEventListener('translate-not-needed', () => {
  document.dispatchEvent(new Event('translation-finished'));
  console.log("üåç ES");
});
</script>

<!-- üôâ Display üôâ -->
<script type="text/javascript">
  document.addEventListener("data-ready", handleDisplayLogic);

  const comparisons = {
    '==': (a, b) => a == b,
    '===': (a, b) => a === b,
    '!=': (a, b) => a != b,
    '!==': (a, b) => a !== b,
    '>': (a, b) => parseFloat(a) > parseFloat(b),
    '<': (a, b) => parseFloat(a) < parseFloat(b),
    '>=': (a, b) => parseFloat(a) >= parseFloat(b),
    '<=': (a, b) => parseFloat(a) <= parseFloat(b),
    'null': (a) => a == null,
    '!null': (a) => a != null,
    'true': (a) => Boolean(a),
    'false': (a) => !Boolean(a)
  };

  function handleDisplayLogic() {
    const elements = document.querySelectorAll("[cf-display-key]");
    const dataCache = new Map();

    elements.forEach((el) => {
      try {
        const key = el.getAttribute("cf-display-key");
        const path = el.getAttribute("cf-display-path");
        let compareExpr = el.getAttribute("cf-display-compare")?.trim();

        if (!key || !path || !compareExpr) {
          console.warn(`Element missing required attributes:`, el);
          return;
        }

        // Cache de datos
        if (!dataCache.has(key)) {
          try {
            const storedData = localStorage.getItem(key);
            dataCache.set(key, storedData ? JSON.parse(storedData) : null);
          } catch (e) {
            console.error(`Error parsing data for key ${key}:`, e);
            dataCache.set(key, null);
          }
        }

        // Obtener valor
        const actualValue = path.split('.').reduce(
          (obj, prop) => (obj?.[prop] !== undefined) ? obj[prop] : null,
          dataCache.get(key)
        );

        // Parseo seguro con comillas simples
        const operatorMatch = compareExpr.match(/^(===?|!==?|[<>]=?|null|!null|true|false)(?:\s*'(.*?)')?/);
        
        const operator = operatorMatch[1];
        let compareValue = operatorMatch[2] || '';

        // Comparaci√≥n
        const comparator = comparisons[operator];
        if (!comparator) {
          console.warn(`Unsupported operator: "${operator}"`, el);
          return;
        }

        el.style.display = comparator(actualValue, compareValue) ? "" : "none";

      } catch (error) {
        console.error("Error processing element:", el, error);
      }
    });

    document.dispatchEvent(new Event("display-ready"));
  }
</script>


<!--‚è∞ Events: cf-loader-off ‚è∞ --->
<script>
  (function() {
    const REQUIRED_EVENTS = [
      "display-ready",
      "submit-ready",        
      "fill-ready",
      "translation-finished"
                ];

    let receivedEvents = new Set();

    function checkAllReady() {
      if (REQUIRED_EVENTS.every(event => receivedEvents.has(event))) {
        console.log("‚è∞ü¶â");
        document.dispatchEvent(new Event("cf-loader-off"));
        resetCoordinator(); // ‚¨ÖÔ∏è Reinicio autom√°tico justo despu√©s
      }
    }

    

    function resetCoordinator() {
      receivedEvents.clear();
    }

    // Escucha todos los eventos requeridos
    REQUIRED_EVENTS.forEach(eventName => {
      document.addEventListener(eventName, () => {
        if (!receivedEvents.has(eventName)) {
          receivedEvents.add(eventName);
          checkAllReady();
        }
      });
    });
  })();
</script>



<!------------------------üêá Options üêá------------------------>

<!-- üéØ Handler üéØ -->
<script>
document.addEventListener("options-builder-ready", () => {
  document.querySelectorAll("[cf-options-value]").forEach(input => {
    input.addEventListener("change", () => {
      const value = input.getAttribute("cf-options-value");
      const label = input.getAttribute("cf-options-label");
      const id = input.getAttribute("cf-options-id"); // Nuevo: capturar ID
      const path = input.getAttribute("cf-options-path");
      const type = input.type;
      const field = input.closest("[data-options-field]");
      const group = input.closest("[data-options-group]");
      const activeClass = input.getAttribute("cf-options-active");

      if (!path || !group) return;

      const hidden = group.querySelector(`input[type="hidden"][cf-json-path="${path}"]`);
      if (!hidden) {
        console.error(`No input hidden con cf-json-path="${path}"`, group);
        return;
      }

      // Manejo diferenciado inicial
      let currentValue;
      if (type === "checkbox") {
        try { currentValue = JSON.parse(hidden.value || "[]"); }
        catch { currentValue = []; console.warn("Error parseando JSON:", hidden.value); }
      } else if (type === "radio") {
        try { currentValue = hidden.value ? JSON.parse(hidden.value) : null; }
        catch { currentValue = null; }
      }

      // Objeto completo con value, label e id
      const entry = { 
        value, 
        label, 
        ...(id && { id }) // Solo incluir ID si existe
      };

      if (type === "checkbox") {
        const isActive = input.checked;
        const exists = currentValue.some(item => item.value === value);

        // Validaci√≥n de l√≠mite (s√≥lo para checkboxes)
        if (isActive && !exists) {
          const limit = hidden.hasAttribute("cf-checkbox-limit") 
                      ? parseInt(hidden.getAttribute("cf-checkbox-limit"))
                      : null;
          
          if (limit !== null && currentValue.length >= limit) {
            showErrorModal(`Selecciona m√°ximo ${limit} opciones.`);
            input.checked = false;
            return;
          }
        }

        field?.classList.toggle(activeClass, isActive);
        
        if (isActive && !exists) {
          currentValue.push(entry);
        } else if (!isActive && exists) {
          currentValue = currentValue.filter(item => item.value !== value);
        }

      } else if (type === "radio") {
        // Radio ahora maneja objeto simple (no array)
        group.querySelectorAll(`[type="radio"][cf-options-path="${path}"]`)
             .forEach(r => r.closest("[data-options-field]")?.classList.remove(activeClass));
        field?.classList.add(activeClass);
        currentValue = entry; // Asignaci√≥n directa del objeto (no array)
      }

      // Serializaci√≥n para Xano (conserva estructura simple)
      hidden.value = type === "checkbox" ? JSON.stringify(currentValue) 
                   : currentValue ? JSON.stringify(currentValue) : "";

      // Evento personalizado actualizado con ID
      document.dispatchEvent(new CustomEvent(`valid-change-${type}`, {
        detail: {
          input,
          value,
          label,
          id, // Nuevo: incluir ID en el evento
          path,
          type,
          isChecked: input.checked
        }
      }));
    });
  });
});

// Funci√≥n auxiliar para mostrar errores (si no existe)
function showErrorModal(message) {
  if (typeof showToast === 'function') {
    showToast(message, 'error');
  } else if (typeof alert === 'function') {
    alert(message);
  } else {
    console.error(message);
  }
}
</script>

<!-- üü¶ Checkbox üü¶ -->
<script>
  document.addEventListener("valid-change-checkbox", (e) => {
    const { input, value, path, isChecked } = e.detail;
    const parent = input.closest('[cf-options-parent]')?.getAttribute("cf-options-parent");


    
    if (!value || !parent) return;

    // 1. Manejo de divs de display (compatible con "any")
    document.querySelectorAll(`
      [cf-options-display-div="${parent}"][cf-options-match="${value}"],
      [cf-options-display-div="${parent}"][cf-options-match="any"]
    `).forEach(div => {
      const isAny = div.getAttribute("cf-options-match") === "any";
      
      // Mostrar si: es "any" O est√° checked (para match espec√≠fico)
      div.style.display = (isAny || isChecked) ? "block" : "none";
      console.log(`üîÑ ${value}: ${isChecked ? 'üôâ' : 'üôà'}`);
    });

// 2. Manejo de grupos hijos y required (con soporte "any")
document.querySelectorAll(`
  [cf-options-child="${parent}"][cf-options-target="${value}"],
  [cf-options-child="${parent}"][cf-options-target="any"]
`).forEach(child => {
  const hiddenInputs = child.querySelectorAll('input[cf-json-path]');
  const isAny = child.getAttribute("cf-options-target") === "any";

  hiddenInputs.forEach(hiddenInput => {
    if (isAny || isChecked) {
      hiddenInput.setAttribute("data-required", "");
    } else {
      hiddenInput.removeAttribute("data-required");
    }
  });
});


// 2. Manejo de directo de inputs (required)
document.querySelectorAll(`
  input[cf-options-child="${parent}"][cf-options-target="${value}"],
  input[cf-options-child="${parent}"][cf-options-target="any"]
`).forEach(input => {
  const isAny = input.getAttribute("cf-options-target") === "any";

  if (isAny || isChecked) {
    input.setAttribute("data-required", "");
  } else {
    input.removeAttribute("data-required");
  }
});




    // 3. Actualizaci√≥n de formulario (sin cambios)
    if (input) {
      const parentForm = input.closest('[cf-form-submit]');
      const formIdentifier = parentForm?.getAttribute('cf-form-submit');

      if (formIdentifier) {
        document.dispatchEvent(new CustomEvent('cf-update-form', {
          detail: { formIdentifier }
        }));
      }
    }
  });
</script>


<!-- üüß Radioüüß -->
<script>
  document.addEventListener("valid-change-radio", (e) => {
    const { input, value, isChecked } = e.detail;
    const parent = input.closest('[cf-options-parent]')?.getAttribute("cf-options-parent");
    if (!value || !parent) return;

    // 1. Ocultar TODOS los divs primero (excepto los "any")
    document.querySelectorAll(`[cf-options-display-div="${parent}"]`).forEach(div => {
      if (div.getAttribute("cf-options-match") !== "any") {
        div.style.display = "none";
      }
    });

    // 2. Mostrar solo los relevantes (match o any)
    document.querySelectorAll(`
      [cf-options-display-div="${parent}"][cf-options-match="${value}"],
      [cf-options-display-div="${parent}"][cf-options-match="any"]
    `).forEach(div => {
      div.style.display = "block";
    });

// 3. L√≥gica de required actualizada (con soporte "any")
// Limpiar TODOS los data-required primero
document.querySelectorAll(`[cf-options-child="${parent}"] input[cf-json-path]`).forEach(input => {
  input.removeAttribute("data-required");
});

// Agregar required a los grupos relevantes
if (isChecked) {
  document.querySelectorAll(`
    [cf-options-child="${parent}"][cf-options-target="${value}"],
    [cf-options-child="${parent}"][cf-options-target="any"]
  `).forEach(child => {
    child.querySelectorAll('input[cf-json-path]').forEach(input => {
      input.setAttribute("data-required", "");
    });
  });
}

// 2. Manejo de directo de inputs (required)
document.querySelectorAll(`
  input[cf-options-child="${parent}"][cf-options-target="${value}"],
  input[cf-options-child="${parent}"][cf-options-target="any"]
`).forEach(input => {
  const isAny = input.getAttribute("cf-options-target") === "any";

  if (isAny || isChecked) {
    input.setAttribute("data-required", "");
  } else {
    input.removeAttribute("data-required");
  }
});







    // 4. Actualizar formulario
    const formIdentifier = input.closest('[cf-form-submit]')?.getAttribute('cf-form-submit');
    formIdentifier && document.dispatchEvent(new CustomEvent('cf-update-form', {
      detail: { formIdentifier }
    }));
  });
</script>



<!----------------------- üê¨ Tools üê¨ ----------------------->


<!-- ü¶ú ResetTabs  ü¶ú -->
<script>
document.addEventListener('creatifornia-ready', function() {
  // Funci√≥n principal para resetear pesta√±as
  function resetTabs() {
    // Seleccionar todas las pesta√±as con el atributo name="cf-reset-tabs"
    const tabsToReset = document.querySelectorAll('[name="cf-reset-tabs"]');
    
    tabsToReset.forEach(tab => {
      // Obtener el ID del componente de pesta√±as Webflow asociado
      const tabsComponent = tab.closest('[data-w-tab]');
      
      if (tabsComponent) {
        // Resetear a ninguna pesta√±a seleccionada
        tabsComponent.setAttribute('data-w-tab', 'none');
        console.log("‚úÖ Tabs reset");
      }
    });
  }

  // Ejecutar al cargar la p√°gina
  resetTabs();

  // Escuchar el evento personalizado
  document.addEventListener('cf-reset-tabs', resetTabs);

});
</script>

<!-- üåÄ Loader üåÄ -->
<script type="text/javascript">
  (function () {
    document.addEventListener("DOMContentLoaded", () => {
      const loaderLink = document.getElementById("loader-link");
      const wrapperLink = document.getElementById("wrapper-link");

      if (loaderLink) loaderLink.click();

      document.addEventListener("cf-loader-on", () => {
        console.log("üôà");
        if (loaderLink) loaderLink.click();
      });

      document.addEventListener("cf-loader-off", () => {
        
        // üåÄ Ocultar loader
        if (wrapperLink) wrapperLink.click();

        // üîÅ Reinicializar interacciones Webflow
        if (window.Webflow && typeof Webflow.require === 'function') {
          const ix2 = Webflow.require('ix2');
          if (ix2 && typeof ix2.init === 'function') {
            ix2.init();
            console.log("üôâ");
          }
        }
      });
    });
  })();
</script>


<!--  üßØ Modal üßØ -->  
  <script>
  function showErrorModal(message) {
    const modal = document.getElementById('error-modal');
    const messageElement = document.getElementById('error-message');
    if (modal && messageElement) {
      messageElement.innerText = message;
      modal.style.display = 'flex';
    } else {
      console.error("‚ùå Elementos del modal no encontrados");
    }
  }

  function closeErrorModal() {
    const modal = document.getElementById('error-modal');
    if (modal) modal.style.display = 'none';
  }
</script>

<!-- üê¨ FillEspecificInputsüê¨ -->
<script>
  document.addEventListener("cf-fill-specific-inputs", (e) => {
    const { key, path, formIdentifier } = e.detail || {};
    
    // Verificaci√≥n temprana de formIdentifier
    if (!formIdentifier) {
      console.warn("‚ö†Ô∏è Evento recibido sin formIdentifier");
      return;
    }
    
    // Verificaci√≥n de par√°metros esenciales
    if (!key || !path) {
      console.error("‚ùå Evento requiere key y path");
      return;
    }

    const selector = `[cf-local-storage-key="${key}"][cf-local-storage-path="${path}"]`;
    const matchingInputs = document.querySelectorAll(selector);

    if (matchingInputs.length === 0) {
      console.warn(`‚ö†Ô∏è No inputs encontrados para key="${key}" y path="${path}"`);
      return;
    }

    let storedData;
    try {
      storedData = JSON.parse(localStorage.getItem(key));
    } catch {
      storedData = null;
    }

    const value = path.split('.').reduce((acc, part) => 
      (acc && acc[part] !== undefined) ? acc[part] : null, storedData);

    matchingInputs.forEach(input => {
      if (value === null) {
        if (input.type === 'checkbox' || input.type === 'radio') {
          input.checked = false;
        } else {
          input.value = '';
        }
        return;
      }

      if (input.type === 'checkbox') {
        input.checked = Boolean(value);
      } else if (input.type === 'radio') {
        if (input.value === value.toString()) input.checked = true;
      } else if (input.tagName === 'SELECT' && input.multiple) {
        // Manejo de arrays para selects m√∫ltiples
        const valuesToSet = Array.isArray(value) ? value : [value];
        Array.from(input.options).forEach(opt => {
          opt.selected = valuesToSet.includes(opt.value);
        });
      } else {
        // Asignaci√≥n est√°ndar (soporta arrays y strings)
        input.value = Array.isArray(value) ? JSON.stringify(value) : value;
      }

      if (!input.placeholder && typeof value === 'string') {
        input.placeholder = value;
      }
    });

    // üîÅ Disparar cf-update-form SIN CONDICIONAMIENTO
    document.dispatchEvent(new CustomEvent("cf-update-form", {
      detail: { formIdentifier }
    }));
  });
</script>

<!-- üëΩ Emojis üëΩ -->
<script>
document.querySelectorAll('[ms-code-emoji]').forEach(element => {
  var imageUrl = element.getAttribute('ms-code-emoji');
  var img = document.createElement('img');
  img.src = imageUrl;

  var textStyle = window.getComputedStyle(element);
  var adjustedHeight = parseFloat(textStyle.fontSize) * 1.0;

  img.style.height = adjustedHeight + 'px';
  img.style.width = 'auto';
  img.style.verticalAlign = 'text-top';

  element.innerHTML = ''; // Clears the text content inside the span
  element.appendChild(img);
});
</script>

<!-- üê¨ ReloadForm üê¨ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Seleccionar todos los elementos con el atributo cf-reload-form
  const reloadElements = document.querySelectorAll('[cf-reload-form]');
  
  // Agregar event listener a cada elemento
  reloadElements.forEach(element => {
    element.addEventListener('click', function(event) {
      // Prevenir comportamiento por defecto si es un enlace
      event.preventDefault();
      
      // Disparar el evento cf-loader-on
      document.dispatchEvent(new CustomEvent('cf-loader-on'));
      
      // Encontrar el formulario padre
      const form = element.closest('[cf-form-submit]');
      if (!form) return;
      
      // 1. Limpiar todos los campos principales (parents)
      const parentContainers = form.querySelectorAll('[cf-options-parent]');
      parentContainers.forEach(container => {
        // Deseleccionar radios y checkboxes
        container.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
          input.checked = false;
        });
        
        // Limpiar valores de hidden inputs principales
        container.querySelectorAll('input[type="hidden"][cf-json-path]').forEach(hiddenInput => {
          if (hiddenInput.hasAttribute('cf-checkbox-limit')) {
            hiddenInput.value = '[]'; // Valor inicial para checkboxes
          } else {
            hiddenInput.value = ''; // Valor inicial para radios
          }
        });
        
        // Quitar clases activas
        container.querySelectorAll('[data-options-field]').forEach(field => {
          const activeClass = field.querySelector('[data-options-button]')?.getAttribute('cf-options-active');
          if (activeClass) {
            field.classList.remove(activeClass);
          }
        });
      });
      
      // 2. Limpiar todos los campos hijos (children)
      const childContainers = form.querySelectorAll('[cf-options-child]');
      childContainers.forEach(container => {
        // Remover data-required de todos los inputs
        container.querySelectorAll('input[data-required]').forEach(input => {
          input.removeAttribute('data-required');
        });
        
        // Deseleccionar radios y checkboxes
        container.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
          input.checked = false;
        });
        
        // Limpiar valores de todos los inputs
        container.querySelectorAll('input').forEach(input => {
          if (input.type !== 'radio' && input.type !== 'checkbox') {
            input.value = '';
          }
        });
        
        // Limpiar valores de hidden inputs espec√≠ficos
        container.querySelectorAll('input[type="hidden"][cf-json-path]').forEach(hiddenInput => {
          if (hiddenInput.hasAttribute('cf-checkbox-limit')) {
            hiddenInput.value = '[]'; // Valor inicial para checkboxes
          } else {
            hiddenInput.value = ''; // Valor inicial para radios
          }
        });
        
        // Quitar clases activas
        container.querySelectorAll('[data-options-field]').forEach(field => {
          const activeClass = field.querySelector('[data-options-button]')?.getAttribute('cf-options-active');
          if (activeClass) {
            field.classList.remove(activeClass);
          }
        });
      });
      
      // 4. Disparar eventos para actualizar el estado
      setTimeout(() => {
        // Disparar eventos de cambio para actualizar el estado
        form.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
          if (input.hasAttribute('cf-options-value')) {
            const event = new CustomEvent(`valid-change-${input.type}`, {
              detail: {
                input,
                value: input.getAttribute('cf-options-value'),
                isChecked: false
              }
            });
            document.dispatchEvent(event);
          }
        });
        
        // Disparar actualizaci√≥n del formulario
        const formIdentifier = form.getAttribute('cf-form-submit');
        if (formIdentifier) {
          document.dispatchEvent(new CustomEvent('cf-update-form', {
            detail: { formIdentifier }
          }));
        }
        
        // Ocultar loader
        document.dispatchEvent(new CustomEvent('cf-loader-off'));
        document.dispatchEvent(new CustomEvent('cf-hide-this'));
      }, 100);
    });
  });

  // Parte 2: Escuchar el evento cf-hide-this (originalmente en script separado)
  document.addEventListener('cf-hide-this', function() {
    setTimeout(() => {
      document.querySelectorAll('[cf-options-display-div]').forEach(div => {
        div.style.display = 'none';
      });
    }, 150);
  });
});
</script>

<!-- üê¨ Click üê¨ -->
<script>
  // Espera a que el evento 'inputs-ready' sea disparado desde OTRO lugar
  document.addEventListener('inputs-ready', () => {
    
    // Configura el mirror click para todos los triggers
    document.querySelectorAll('[cf-click-trigger]').forEach(trigger => {
      const targetId = trigger.getAttribute('cf-click-trigger');
      
      trigger.addEventListener('click', () => {
        // Activa TODOS los elementos target correspondientes
        document.querySelectorAll(`[cf-click-target="${targetId}"]`).forEach(target => {
          target.click();
          target.focus(); // Asegura que los inputs reciban foco
        });
      });
    });
    
  });
</script>

<!-- üå¥Refreshüå¥ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const alreadyRefreshed = sessionStorage.getItem("cf-refreshed");

  const url = new URL(window.location.href);
  const params = url.searchParams;

  const hasRefreshParam = params.has("refresh");
  const hasForceParam = params.has("force");

  // ‚úÖ Forzar refresh si "force" est√° presente, ignorando el flag de sessionStorage
  if ((hasRefreshParam && !alreadyRefreshed) || hasForceParam) {
    sessionStorage.setItem("cf-refreshed", "true");
    console.log("üîÅ Refresh.");

    // Elimina los par√°metros "refresh" y "force" de la URL
    params.delete("refresh");
    params.delete("force");

    // Reconstruye la URL con los par√°metros restantes
    const newUrl = url.pathname + (params.toString() ? '?' + params.toString() : '') + url.hash;

    setTimeout(() => {
      window.location.href = newUrl;
    }, 500);
  }
});
</script>




 <!--------------------- üêû Uploadcare üêû  ---------------------> actualizar
 
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/web/uc-file-uploader-regular.min.css" />

<script type="module">
  import * as UC from 'https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/web/file-uploader.min.js';
  import es from 'https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/locales/file-uploader/es.js';
  import en from 'https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/locales/file-uploader/en.js';


document.addEventListener('data-ready', () => {

 // Funci√≥n segura para obtener valores desde localStorage.offices
        function getOffices(path) {
            try {
                const data = JSON.parse(localStorage.getItem("offices") || "{}");
                return path.split('.').reduce((acc, key) => acc?.[key], data);
            } catch (e) {
                console.error("‚ùå Error parsing offices from localStorage:", e);
                return null;
            }
        }
        
 

  // Funci√≥n para inicializar UploadCare con el locale correcto
  const initUploadCare = () => {
    try {
      const lang = getOffices('country.lang.ISO_639');
      
      if (lang === 'es') {
        UC.defineLocale('es', es);
      } else {
        UC.defineLocale('en', en);
      }

      UC.defineComponents(UC);
      
      // Disparar evento de finalizaci√≥n
      document.dispatchEvent(new Event('uploadcare-ready'));
      console.log('üêû Uploadcare');
      
    } catch (error) {
      console.error('Error initializing UploadCare:', error);
      // Fallback a espa√±ol si ocurre alg√∫n error
      UC.defineLocale('es', es);
      UC.defineComponents(UC);
      
      // Disparar evento incluso en caso de error (pero marcado como fallo)
      const errorEvent = new CustomEvent('uploadcare-ready', {
        detail: { error: true, message: error.message }
      });
      document.dispatchEvent(errorEvent);
    }
  };
});
</script>

<!---------------------üê∏ HTML üê∏--------------------->

<!-- üê∏ MODAL response error  üê∏ -->

<div id="error-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#292626; padding:2rem; border-radius:1rem; max-width:400px; width:90%; text-align:center; color:#e7cfb1; font-family:sans-serif; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
      <h2 style="margin-bottom:1rem; font-size:18px;">üîî</h2> <!-- T√≠tulo m√°s peque√±o -->
      <p id="error-message" style="margin-bottom:2rem; font-size:20px; font-weight:bold;"></p> <!-- Mensaje m√°s grande -->
      <button onclick="closeErrorModal()" style="background:#e5813e; color:#292626; border:none; padding:0.75rem 1.5rem; border-radius:0.5rem; cursor:pointer; font-weight:bold;">
        Close
      </button>
    </div>
  </div>