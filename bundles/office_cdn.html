<!-------------------------ü¶© Data ü¶©------------------------>
<!-- üíº Offices üíº -->
<script type="text/javascript">
  const CRUCIAL_PATHS = [
    'country.currency.ISO_4217',
    'club.plan_id',
    'country.lang.ISO_639',
    'country.ISO_3166_1_alfa_2'
  ];

  const MAX_RETRIES = 10;
  const RETRY_INTERVAL = 200; // ms
  const WAIT_TIME_AFTER_FAILURE = 30000; // 30 seconds

  document.addEventListener("DOMContentLoaded", initCreatifornia);
  document.addEventListener("get-creatifornia", initCreatifornia);

  function initCreatifornia() {
    const authToken = localStorage.getItem("AuthToken");
    if (!authToken) return;

    xano.setAuthToken(authToken);
    xano.get('/offices').then(response => {
      if (response && response.body) {
        localStorage.setItem("offices", JSON.stringify(response.body));
        validateCrucialPaths(response.body, 0);
      }
    }).catch(error => {
      console.error("‚ùå Error al obtener datos de Creatifornia:", error);
    });
  }

  function validateCrucialPaths(data, attempt) {
    if (allCrucialPathsExist(data)) {
      console.log("üíº Offices");
      document.dispatchEvent(new Event("creatifornia-ready"));
      return;
    }

    if (attempt < MAX_RETRIES) {
      setTimeout(() => {
        const storedData = JSON.parse(localStorage.getItem("offices") || "{}");
        validateCrucialPaths(storedData, attempt + 1);
      }, RETRY_INTERVAL);
    } else {
      console.warn("‚ö†Ô∏è Crucial paths no encontrados tras m√∫ltiples intentos. Esperando 30 segundos para reintentar.");
      setTimeout(() => {
        document.dispatchEvent(new Event("get-creatifornia"));
      }, WAIT_TIME_AFTER_FAILURE);
    }
  }

  function allCrucialPathsExist(data) {
    return CRUCIAL_PATHS.every(path => {
      const value = getNestedValue(data, path);
      return value !== undefined && value !== null;
    });
  }

  function getNestedValue(obj, path) {
    return path.split('.').reduce((acc, key) => {
      return acc && acc[key] !== undefined ? acc[key] : undefined;
    }, obj);
  }
</script>

<!--‚è∞ data-ready ‚è∞ --> 
<script> //a√±adir dvento de actualizar cache si es necesario
  (function() {
    const REQUIRED_EVENTS = [
      "creatifornia-ready"

    ];

    let receivedEvents = new Set();
    let readyTimer = null;

    function checkAllReady() {
      if (REQUIRED_EVENTS.every(event => receivedEvents.has(event))) {
        clearTimeout(readyTimer); // Cancelar timer previo si existe
        readyTimer = setTimeout(() => {
          console.log("‚è∞ü¶©");
          document.dispatchEvent(new Event("data-ready"));
          resetCoordinator();
        }, 300); 
      }
    }

    function resetCoordinator() {
      receivedEvents.clear();
    }

    REQUIRED_EVENTS.forEach(eventName => {
      document.addEventListener(eventName, () => {
        if (!receivedEvents.has(eventName)) {
          receivedEvents.add(eventName);
          checkAllReady();
        }
      });
    });
  })();
</script> 



<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/Dynamic-API-v1-1.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/Dynamic-Cache-v1.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/Data-API.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/Data-API-Cache-v1-2.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/Translate-API-v1-2.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/Translate-Cache-v1-3.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/Events-Data.js" defer></script>


<!------------------------üê≥ Fill  üê≥ ------------------------>

<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Fill/Inputs-v1.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Fill/Direct-v1.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Fill/Events-Fill-v1.js" defer></script>


<!------------------------üß± Components üß±---------------------->
<script>
document.addEventListener("data-ready", function () {
  function getCache(key, path) {
    try {
      const data = JSON.parse(localStorage.getItem(key));
      return path.split('.').reduce((acc, part) => acc?.[part], data);
    } catch (e) {
      console.warn(`‚ö†Ô∏è Error accediendo a ${key}.${path}`);
      return undefined;
    }
  }

  const currencyCents = !!getCache('offices', 'country.currency.cents');
  if (!currencyCents) {
    document.dispatchEvent(new Event('plan-calculator-cents'));
    return;
  }

  const planCalculators = document.querySelectorAll('[plan_calculator]');
  const currency = getCache('offices', 'country.currency.ISO_4217');
  const currencySymbol = getCache('offices', 'country.currency.symbol');

  if (!currency) {
    console.error('No se pudo obtener la moneda');
    return;
  }

  planCalculators.forEach(calculator => {
    const planId = calculator.getAttribute('plan_id');
    const limit = parseInt(calculator.getAttribute('limit') || 5);
    const jsonPath = calculator.getAttribute('json-path');
    const clickThisId = calculator.getAttribute('click_this');

    const firstUnit = parseFloat(getCache('data', `scalable_plans.${planId}.${currency}.raw_value_1`));
    const secondUnit = parseFloat(getCache('data', `scalable_plans.${planId}.${currency}.raw_value_second_unit`));

    if (isNaN(firstUnit) || isNaN(secondUnit)) {
      console.error(`Datos incompletos o inv√°lidos para plan ${planId} y moneda ${currency}`);
      return;
    }

    const currencyElement = calculator.querySelector('[currency]');
    const unitElement = calculator.querySelector('[first_unit][second_unit]');
    const symbolElement = calculator.querySelector('[symbol]');
    const StorageUnitElement = calculator.querySelector('[storage_unit]');
    const StorageUnit = StorageUnitElement?.getAttribute('storage_unit');
    const storageBaseElement = calculator.querySelector('[storage_base]');
    const decreaseButton = calculator.querySelector('[cf="disminuir"]')?.closest('a');
    const increaseButton = calculator.querySelector('[cf="aumentar"]')?.closest('a');

    if (currencyElement) currencyElement.textContent = currency;
    const storageBase = parseInt(storageBaseElement?.getAttribute('storage_base'));
    let currentLevel = 1;
    let currentAmount = firstUnit;

    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = jsonPath;
    hiddenInput.setAttribute('cf-json-path', jsonPath);
    hiddenInput.setAttribute('data-required', 'true');
    hiddenInput.value = currentLevel;
    calculator.appendChild(hiddenInput);

    function updateUI() {
      if (storageBaseElement) {
        storageBaseElement.textContent = storageBase * currentLevel;
      }
      if (unitElement) {
        unitElement.textContent = `${currencySymbol}${currentAmount.toFixed(2)}`;
      }
      if (symbolElement) {
        symbolElement.textContent = currencySymbol;
      }
      if (StorageUnitElement) {
        StorageUnitElement.textContent = StorageUnit;
      }
      if (decreaseButton) {
        decreaseButton.classList.toggle('inutil', currentLevel === 1);
      }
    }

    if (decreaseButton) {
      decreaseButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentLevel > 1) {
          currentLevel--;
          currentAmount = currentLevel === 1 ? firstUnit : currentAmount - secondUnit;
          updateUI();
        }
      });
    }

    if (increaseButton) {
      increaseButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentLevel < limit) {
          currentLevel++;
          currentAmount = currentAmount + secondUnit;
          updateUI();
        } else if (clickThisId) {
          document.getElementById(clickThisId)?.click();
        }
      });
    }

    updateUI();
  });

  document.dispatchEvent(new Event('plan-calculator-ready'));
});
</script>



<!----------------------- ‚ö° Form ‚ö° ------------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Form/form-submit.js" defer></script>

<!------------------------üôâ Display üôâ ---------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Display/Translate-Binding-v1.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Display/Display.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Display/Events-Display.js" defer></script>


<!------------------------üêá Handlers üêá---------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Handlers/options-handler.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Handlers/options-checkbox.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Handlers/options-radio.js" defer></script>

<!----------------------- üê¨ Tools üê¨ ------------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/loader.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/fill-specific-inputs.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/mirror-click-v3.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/modal-error.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/refresh.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/reload-form.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/universal-emojis.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/reset-tabs.js" defer></script>


<!----------------------- üêû Uploadcare üêû  ------------------>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/web/uc-file-uploader-regular.min.css" />
<script src="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/web/file-uploader.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/locales/file-uploader/es.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/locales/file-uploader/en.js"></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Uploadcare/Function-v1-1.js" defer></script>




<!------------------------üê∏ HTML üê∏-------------------------->
<!-- MODAL response error -->
<div id="error-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#292626; padding:2rem; border-radius:1rem; max-width:400px; width:90%; text-align:center; color:#e7cfb1; font-family:sans-serif; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
      <h2 style="margin-bottom:1rem; font-size:18px;">üîî</h2> <!-- T√≠tulo m√°s peque√±o -->
      <p id="error-message" style="margin-bottom:2rem; font-size:20px; font-weight:bold;"></p> <!-- Mensaje m√°s grande -->
      <button onclick="closeErrorModal()" style="background:#e5813e; color:#292626; border:none; padding:0.75rem 1.5rem; border-radius:0.5rem; cursor:pointer; font-weight:bold;">
        Close
      </button>
    </div>
  </div>


