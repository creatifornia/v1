<!-------------------------ü¶ú Data ü¶ú-------------------------> 
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/offices.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/options.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/dynamic-text.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/translate.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/data-api-v1.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Data/events-data-v1.js" defer></script>

<!------------------------üê≥ Fill  üê≥ ------------------------>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Fill/fill-text.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Fill/fill-inputs.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Fill/direct-inputs.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Fill/events-fill.js" defer></script>

<!------------------------üß± Builders üß±---------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Builders/options.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Builders/currency.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Builders/keywords.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Builders/url-friendly-v1.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Builders/events-builders.js" defer></script>

<!----------------------- ‚ö° Form ‚ö° ------------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Form/form-submit.js" defer></script>

<!------------------------üôâ Display üôâ ---------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Display/translation.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Display/display.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Display/events-display-v1.js" defer></script>


<!------------------------üêá Handlers üêá---------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Handlers/options-handler.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Handlers/options-checkbox.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Handlers/options-radio.js" defer></script>

<!----------------------- üê¨ Tools üê¨ ------------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/loader.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/fill-specific-inputs.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/mirror-click-v3.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/modal-error.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/refresh.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/reload-form.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/universal-emojis.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/Tools/reset-tabs.js" defer></script>

<!----------------------- üê¨ .get('') üê¨ ---------------------->
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/window-data/DynamicText.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/creatifornia/v1@main/office/window-data/OfficesText.js" defer></script>

<!----------------------- üêû Uploadcare üêû  ------------------>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/web/uc-file-uploader-regular.min.css" />
<script type="module">
  import * as UC from 'https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/web/file-uploader.min.js';
  import es from 'https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/locales/file-uploader/es.js';
  import en from 'https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/locales/file-uploader/en.js';

  // Funci√≥n para inicializar UploadCare con el locale correcto
  const initUploadCare = () => {
    try {
      const lang = window.OfficesText?.get('country.lang.ISO_639') || 'es'; // Safe access with optional chaining
      
      if (lang === 'es') {
        UC.defineLocale('es', es);
      } else {
        UC.defineLocale('en', en); // Default to English for any non-Spanish language
      }

      UC.defineComponents(UC);
    } catch (error) {
      console.error('Error initializing UploadCare:', error);
      // Fallback to Spanish if any error occurs
      UC.defineLocale('es', es);
      UC.defineComponents(UC);
    }
  };

  // Esperar a que los textos din√°micos est√©n listos
  if (window.DynamicText && window.OfficesText) {
    document.addEventListener('dynamic_text-ready', initUploadCare);
  } else {
    // Cargar con valores por defecto si no existe el sistema de textos
    console.warn('DynamicText/OfficesText no disponibles, cargando UploadCare con espa√±ol por defecto');
    UC.defineLocale('es', es);
    UC.defineComponents(UC);
  }
</script>
<!------------------------üê∏ HTML üê∏-------------------------->
<!-- MODAL response error -->
<div id="error-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#292626; padding:2rem; border-radius:1rem; max-width:400px; width:90%; text-align:center; color:#e7cfb1; font-family:sans-serif; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
      <h2 style="margin-bottom:1rem; font-size:18px;">üîî</h2> <!-- T√≠tulo m√°s peque√±o -->
      <p id="error-message" style="margin-bottom:2rem; font-size:20px; font-weight:bold;"></p> <!-- Mensaje m√°s grande -->
      <button onclick="closeErrorModal()" style="background:#e5813e; color:#292626; border:none; padding:0.75rem 1.5rem; border-radius:0.5rem; cursor:pointer; font-weight:bold;">
        Close
      </button>
    </div>
  </div>

<style>
/* Estilo para inhabilitar elementos */
.inutil {
    pointer-events: none !important;
    user-select: none !important;
    cursor: not-allowed !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Buscar todos los componentes plan_calculator
    const planCalculators = document.querySelectorAll('[plan_calculator]');
    
    // Obtener datos de oficina desde localStorage
    const offices = JSON.parse(localStorage.getItem('offices') || '{}');
    const currency = offices?.country?.currency?.ISO_4217;
    
    if (!currency) {
        console.error('No se pudo obtener la moneda desde localStorage');
        return;
    }

    planCalculators.forEach(calculator => {
        // Obtener atributos del componente
        const planId = calculator.getAttribute('plan_id');
        const limit = parseInt(calculator.getAttribute('limit') || 5);
        const jsonPath = calculator.getAttribute('json-path');
        const clickThisId = calculator.getAttribute('click_this');
        
        // Obtener elementos internos
        const symbolElement = calculator.querySelector('[symbol]');
        const currencyElement = calculator.querySelector('[currency]');
        const unitElement = calculator.querySelector('[first_unit][second_unit]');
        const storageBaseElement = calculator.querySelector('[storage_base]');
        const storageUnitElement = calculator.querySelector('[storage_unit]');
        const decreaseButton = calculator.querySelector('[cf="disminuir"]')?.closest('a');
        const increaseButton = calculator.querySelector('[cf="aumentar"]')?.closest('a');
        const clickTrigger = calculator.querySelector('[cf-click-trigger]');
        
        // Asignar la moneda obtenida al elemento en pantalla
        if (currencyElement) {
            currencyElement.textContent = currency;
        }

        // Obtener datos del plan desde localStorage
        const data = JSON.parse(localStorage.getItem('data'));
        const planData = data?.scalable_plans?.[planId]?.[currency];
        
        if (!planData) {
            console.error(`Plan data not found for ID: ${planId} and currency: ${currency}`);
            return;
        }
        
        // Configurar elementos est√°ticos
        if (symbolElement) {
            symbolElement.textContent = planData.symbol;
        }
        
        if (storageUnitElement) {
            storageUnitElement.textContent = storageUnitElement.getAttribute('storage_unit');
        }
        
        // Configurar valores iniciales
        const storageBase = parseInt(storageBaseElement?.getAttribute('storage_base') || '200');
        const firstUnit = parseFloat(planData.raw_value_1);
        const secondUnit = parseFloat(planData.raw_value_second_unit);
        let currentLevel = 1;
        let currentUnit = firstUnit;
        
        // Crear input hidden
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = jsonPath;
        hiddenInput.setAttribute('cf-json-path', jsonPath);
        hiddenInput.setAttribute('data-required', 'true');
        hiddenInput.value = currentLevel;
        calculator.appendChild(hiddenInput);
        
        // Funci√≥n para actualizar UI
        function updateUI() {
            // Actualizar almacenamiento
            if (storageBaseElement) {
                storageBaseElement.textContent = storageBase * currentLevel;
            }
            
            // Actualizar precio unitario
            if (unitElement) {
                unitElement.textContent = planData.symbol + currentUnit.toFixed(2);
            }
            
            // Actualizar estado del bot√≥n disminuir
            if (decreaseButton) {
                decreaseButton.classList.toggle('inutil', currentLevel === 1);
            }
        }
        
        // Configurar eventos de botones
        if (decreaseButton) {
            decreaseButton.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentLevel > 1) {
                    currentLevel--;
                    currentUnit = (currentLevel === 1) ? firstUnit : (currentUnit - secondUnit);
                    updateUI();
                }
            });
        }
        
        if (increaseButton) {
            increaseButton.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentLevel < limit) {
                    currentLevel++;
                    currentUnit += secondUnit;
                    updateUI();
                } else if (currentLevel === limit && clickThisId) {
                    // Disparar evento en el elemento click_this sin cambiar el nivel
                    document.getElementById(clickThisId)?.click();
                }
            });
        }
        
        // Configurar clickTrigger si existe
        if (clickTrigger && clickThisId) {
            clickTrigger.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById(clickThisId)?.click();
            });
        }
        
        // Inicializar UI
        updateUI();
    });
});
</script>