<!-- ==========================================
     DateTime single picker (Flatpickr) - Webflow
     Pegar dentro de tu <form> en Webflow
     ========================================== -->

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Componente -->
<div class="wf-datetime-picker hover-cursor" data-datetime-component>

  <!-- Hidden input de Webflow -->
  <input type="hidden" name="selected_datetime" cf-json-path="selected_datetime" id="wf_hidden_datetime" value="">

  <!-- Single picker control visual -->
  <label class="wf-dt-row" for="wf_datetime_input">
    <input class="wf-dt-input" type="text" id="wf_datetime_input" placeholder="Selecciona fecha y hora" aria-label="Selecciona fecha y hora" autocomplete="off" />
  </label>

  <div class="wf-dt-actions">
    <button type="button" class="button Hover Cursor inutil" id="wf_confirm_btn" aria-disabled="true" tr="confirmar">Confirmar</button>
  </div>
</div>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- ===========================
     Styles (estética + overrides Flatpickr)
     =========================== -->
<style>
  :root{
    --wf-dt-bg: transparent;
    --wf-dt-border: #e7cfb1;
    --wf-dt-accent: #e5813e;
    --wf-dt-text: #292626;
    --wf-dt-muted: #8b8176;
    --wf-dt-radius: 12px;
    --wf-dt-shadow: 0 6px 18px rgba(17,24,39,0.06);
    --wf-flat-bg: #fff;
    --wf-flat-accent: #e7cfb1;
  }

  .wf-datetime-picker{
    display: grid;
    gap: 10px;
    padding: 14px;
    background: var(--wf-dt-bg);
    border: 1px solid var(--wf-dt-border);
    border-radius: var(--wf-dt-radius);
    box-shadow: var(--wf-dt-shadow);
    max-width: 520px;
    font-family: 'Satoshi Variable', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color: var(--wf-dt-text);
  }

  .wf-dt-row{ display:flex; flex-direction:column; gap:6px; }

  .wf-dt-input{
    height:44px;
    padding:8px 12px;
    border-radius:12px;
    border:1px solid var(--wf-dt-border);
    outline:none;
    font-size:15px;
    background:transparent;
    transition: box-shadow .15s, border-color .15s;
    color: #e7cfb1;
    width:100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  .wf-dt-input:focus{ box-shadow:0 6px 18px rgba(231,207,177,0.12); border-color:var(--wf-dt-accent); }

  .wf-dt-actions{ display:flex; align-items:center; gap:12px; margin-top:6px; }

  /* Button base tweaks to improve touch behaviour */
  .button {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
  }


  .wf-dt-confirm{
    padding:10px 16px;
    border-radius:12px;
    border:none;
    font-weight:700;
    cursor:pointer;
    background:#e7cfb1;
    color:#292626;
    transition: transform .06s ease, opacity .12s ease, box-shadow .12s ease;
  }

  /* Flatpickr overrides para que combine con tu estilo */
  .flatpickr-calendar{
    border-radius:10px !important;
    border:1px solid var(--wf-dt-border) !important;
    box-shadow: 0 12px 30px rgba(17,24,39,0.08) !important;
    background: var(--wf-flat-bg) !important;
    color: var(--wf-dt-text) !important;
  }

  .flatpickr-day.selected, .flatpickr-day.today{
    background: var(--wf-flat-accent) !important;
    color: #292626 !important;
    border-color: #e7cfb1;
  }
  .flatpickr-weekday{ color: var(--wf-dt-muted) !important; }
  .flatpickr-months .flatpickr-current-month .flatpickr-month{ color:var(--wf-dt-text) !important; }
  .flatpickr-time input{ color: var(--wf-dt-text) !important; }

  /* ============================
     Mejoras visuales de las flechas (arrowUp / arrowDown)
     - tamaño mayor
     - siempre visibles
     - mejor target táctil
     ============================ */

  .flatpickr .numInputWrapper {
    position: relative;
    padding-right: 48px; /* espacio para las flechas */
  }

  .flatpickr .numInputWrapper .arrowUp,
  .flatpickr .numInputWrapper .arrowDown {
    position: absolute;
    right: 8px;
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: var(--wf-flat-accent);
    color: #292626;
    font-size: 14px;
    line-height: 1;
    box-shadow: 0 6px 12px rgba(17,24,39,0.08);
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  .flatpickr .numInputWrapper .arrowUp { top: 4px; }
  .flatpickr .numInputWrapper .arrowDown { bottom: 4px; }

  /* sustituimos cualquier contenido interno por triángulos legibles */
  .flatpickr .numInputWrapper .arrowUp::after { content: "▲"; font-weight: 700; }
  .flatpickr .numInputWrapper .arrowDown::after { content: "▼"; font-weight: 700; }

  /* aumentar clickable area en móviles */
  .flatpickr .numInputWrapper input.flatpickr-hour,
  .flatpickr .numInputWrapper input.flatpickr-minute {
    padding-right: 54px;
  }

  /* Mejor contraste en estado hover/active */
  .flatpickr .numInputWrapper .arrowUp:active,
  .flatpickr .numInputWrapper .arrowDown:active {
    transform: translateY(1px);
    box-shadow: 0 4px 10px rgba(17,24,39,0.12);
  }

  @media (max-width:520px){
    .wf-datetime-picker{ max-width:100%; padding:12px; }
    .wf-dt-actions{ flex-direction:column; align-items:flex-start; gap:8px; }
    .flatpickr .numInputWrapper .arrowUp,
    .flatpickr .numInputWrapper .arrowDown {
      width: 40px;
      height: 40px;
      right: 6px;
    }
  }
</style>

<!-- ===========================
     Script: Flatpickr combined date+time + lógica
     =========================== -->
<script>
(function(){
  'use strict';

  /* ------------- CONFIG ------------- */
  const CONTINUE_BUTTON_ID = 'continue-id'; // <- cambia aquí
  const HIDDEN_INPUT_ID = 'wf_hidden_datetime';
  const HIDDEN_CF_JSON_PATH = 'selected_datetime'; // informativo
  const PREVENT_PAST = true;      // true => intentamos prevenir selección pasada
  const DATETIME_FORMAT = 'iso';  // 'iso' | 'human' -> valor guardado en hidden
  const TIME_24H = true;          // formato de tiempo de flatpickr
  const FORCE_FLATPICKR_ON_MOBILE = true; // true para forzar Flatpickr en móviles

  /* ------------- ELEMENTS ------------- */
  const root = document.querySelector('[data-datetime-component]');
  if (!root) return;
  const pickerInput = root.querySelector('#wf_datetime_input');
  const confirmBtn = root.querySelector('#wf_confirm_btn');
  const hiddenInput = root.querySelector('#'+HIDDEN_INPUT_ID);

  /* ------------- HELPERS ------------- */
  function toLocalISO(dateObj){
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth()+1).padStart(2,'0');
    const d = String(dateObj.getDate()).padStart(2,'0');
    const H = String(dateObj.getHours()).padStart(2,'0');
    const M = String(dateObj.getMinutes()).padStart(2,'0');
    const S = String(dateObj.getSeconds()).padStart(2,'0');
    return `${y}-${m}-${d}T${H}:${M}:${S}`;
  }

  function setHiddenValue(val){
    if (!hiddenInput) return;
    hiddenInput.value = val;
    hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
  }

  /* ------------- Robust enable/disable for all devices ------------- */
  function setConfirmEnabled(enabled){
    try {
      if (enabled){
        // enable: remove class + property
        confirmBtn.classList.remove('inutil');
        confirmBtn.removeAttribute('disabled');
        confirmBtn.disabled = false;
        confirmBtn.setAttribute('aria-disabled','false');
      } else {
        // disable: add class + disabled property (critical for mobile)
        confirmBtn.classList.add('inutil');
        confirmBtn.setAttribute('aria-disabled','true');
        confirmBtn.disabled = true;

        // Force blur of active element (removes :active and focus)
        try { if (document.activeElement && typeof document.activeElement.blur === 'function') document.activeElement.blur(); } catch(e){}

        // Dispatch pointerup/mouseup on the button and document to cancel press states
        try {
          const ev = new MouseEvent('mouseup', { bubbles: true, cancelable: true });
          confirmBtn.dispatchEvent(ev);
          document.dispatchEvent(ev);
        } catch(e){}

        try {
          // pointerup if supported
          const pev = typeof PointerEvent === 'function' ? new PointerEvent('pointerup', { bubbles: true }) : null;
          if (pev) { confirmBtn.dispatchEvent(pev); document.dispatchEvent(pev); }
        } catch(e) {}

        // For touch devices try a generic event on document
        try { document.dispatchEvent(new Event('touchend', { bubbles: true })); } catch(e){}

        // Force reflow so styles apply immediately
        try { void confirmBtn.offsetWidth; } catch(e){}
      }
    } catch(e){}
  }

  /* ------------- Flatpickr init ------------- */
  const fp = flatpickr(pickerInput, {
    enableTime: true,
    noCalendar: false,
    dateFormat: 'Y-m-d H:i',       // valor interno en input
    altInput: true,
    altFormat: 'F j, Y H:i',       // texto bonito visible
    time_24hr: TIME_24H,
    minuteIncrement: 5,
    allowInput: false,
    disableMobile: !FORCE_FLATPICKR_ON_MOBILE ? false : true,
    minDate: PREVENT_PAST ? new Date() : null,
    onChange: handlePickerChange,
    onOpen: handlePickerOpen,
    onReady: enhanceTimeArrows
  });

  function handlePickerOpen(selectedDates, dateStr, instance){
    // nothing special needed here for now
  }

  function isSelectedPast(){
    const d = fp.selectedDates && fp.selectedDates[0];
    if (!d) return false;
    return d.getTime() < Date.now();
  }

  function handlePickerChange(selectedDates){
    const valid = Array.isArray(selectedDates) && selectedDates.length > 0 && !(PREVENT_PAST && isSelectedPast());
    setConfirmEnabled(valid);
  }

  /* ------------- Inicializar desde hidden si ya tiene valor ------------- */
  (function initFromHidden(){
    try {
      const raw = hiddenInput && hiddenInput.value;
      if (raw && raw.trim()){
        if (raw.indexOf('T') > -1){
          const [d, t] = raw.split('T');
          const hhmm = t.split(':').slice(0,2).join(':');
          const dt = new Date(d + 'T' + hhmm + ':00');
          if (!isNaN(dt.getTime())){
            fp.setDate(dt, true, 'Y-m-d H:i');
            setConfirmEnabled(!(PREVENT_PAST && dt.getTime() < Date.now()));
            return;
          }
        } else {
          fp.setDate(raw, true);
          setConfirmEnabled(fp.selectedDates.length>0 && !(PREVENT_PAST && isSelectedPast()));
          return;
        }
      }
    } catch(e){}
    setConfirmEnabled(false);
  })();

  /* ------------- Confirmar (actualiza hidden + dispara evento) ------------- */
  confirmBtn.addEventListener('click', function(evt){
    evt.preventDefault();
    if (confirmBtn.classList.contains('inutil')) return;

    const sel = fp.selectedDates && fp.selectedDates[0];
    if (!sel) return;

    if (PREVENT_PAST && sel.getTime() < Date.now()){
      setConfirmEnabled(false);
      return;
    }

    const iso = toLocalISO(sel);
    if (DATETIME_FORMAT === 'iso') setHiddenValue(iso);
    else {
      const y = iso.slice(0,4), m = iso.slice(5,7), day = iso.slice(8,10), t = iso.slice(11,16);
      setHiddenValue(`${day}/${m}/${y} ${t}`);
    }

    const detail = {
      continueButtonId: CONTINUE_BUTTON_ID,
      jsonPath: HIDDEN_CF_JSON_PATH,
      value: hiddenInput ? hiddenInput.value : iso
    };
    document.dispatchEvent(new CustomEvent('valid-change-hidden', { detail }));

    // Después de confirmar, volvemos a dejar el botón en estado "inutil"
    setConfirmEnabled(false);
  });

  // prevenir pegar en el input (flatpickr controla la selección)
  pickerInput.addEventListener('paste', (e) => e.preventDefault());


  /* ------------- Helpers to improve arrows UI ------------- */
  function enhanceTimeArrows() {
    // Flatpickr genera .flatpickr-time en el calendario. Buscamos numInputWrapper y aseguramos
    // que las flechas existan y sean accesibles. Si no existieran (versiones futuras), las añadimos.
    try {
      const calendars = document.querySelectorAll('.flatpickr-calendar');
      calendars.forEach(cal => {
        cal.querySelectorAll('.numInputWrapper').forEach(wrapper => {
          // si no existe arrowUp/Down explícitos, creamos/aseguramos
          let up = wrapper.querySelector('.arrowUp');
          let down = wrapper.querySelector('.arrowDown');
          if (!up) {
            up = document.createElement('span');
            up.className = 'arrowUp';
            wrapper.appendChild(up);
          }
          if (!down) {
            down = document.createElement('span');
            down.className = 'arrowDown';
            wrapper.appendChild(down);
          }

          // mejorar target táctil: agrandar el area usando padding + event listeners
          [up, down].forEach(el => {
            el.style.touchAction = 'manipulation';
            el.style.webkitTapHighlightColor = 'transparent';
            // click delegated to increase/decrease numeric input
            el.onclick = function(e){
              e.stopPropagation();
              // find sibling input (hour or minute)
              const inputEl = wrapper.querySelector('input.numInput, input.flatpickr-hour, input.flatpickr-minute');
              if (!inputEl) return;
              // decide si this is up or down and step accordingly (flatpickr minute step is usually 5)
              const step = parseInt(inputEl.getAttribute('step') || '1', 10);
              const min = parseInt(inputEl.getAttribute('min') || '0', 10);
              const max = parseInt(inputEl.getAttribute('max') || '59', 10);
              let val = parseInt(inputEl.value || '0', 10);
              if (isNaN(val)) val = min;
              if (this.classList.contains('arrowUp')) {
                val = Math.min(max, val + step);
              } else {
                val = Math.max(min, val - step);
              }
              inputEl.value = String(val).padStart(2,'0');
              // trigger change so flatpickr updates
              inputEl.dispatchEvent(new Event('change', { bubbles: true }));
            };
          });

        });
      });
    } catch(e){}
  }

})();
</script>