<!-- RESET -->
<script>
(function () {
  'use strict';

  /* ---------- Utils ---------- */
  function safeJSONParse(str, fallback = null) {
    try { return JSON.parse(str); } catch (e) { return fallback; }
  }

  function getInitialHiddenValue(inputType) {
    return inputType === 'checkbox' ? '[]' : '{}';
  }

  /* ---------- Clean deep components ---------- */
  function cleanChildComponents(container) {
    if (!container || !(container instanceof Element)) return;

    // 1. Limpieza de elementos del Color Picker
    container.querySelectorAll('a[color-element-template]').forEach(el => {
      console.debug('Reset: Simulating click on color picker element:', el);
      el.click();
    });
    const selectColorBtn = container.querySelector('[internal-input-select-color]');
    if (selectColorBtn) {
      selectColorBtn.style.borderColor = '';
      selectColorBtn.style.color = '';
      selectColorBtn.classList.remove('previewed');
    }

    // 2. Limpieza de elementos de Uploader de Uploadcare
    container.querySelectorAll('uc-file-item .uc-remove-btn').forEach(button => {
      console.debug('Reset: Simulating click on Uploadcare remove button:', button);
      button.click();
    });

    // 3. Limpieza de campos contenteditable
    container.querySelectorAll('[contenteditable="true"]').forEach(el => {
      console.debug('Reset: Cleaning contenteditable element:', el);
      el.innerHTML = '';
    });

    // 4. Limpieza de inputs nativos y hidden
    container.querySelectorAll('input, textarea, select').forEach(i => {
      try {
        if (i instanceof HTMLInputElement && (i.type === 'checkbox' || i.type === 'radio')) {
          i.checked = false;
        } else {
          i.value = '';
        }
        if (i.selectedIndex !== undefined) try { i.selectedIndex = -1; } catch (e) {}
      } catch (e) {}
    });

    container.querySelectorAll('[component-id] input[type="hidden"][cf-json-path]').forEach(h => {
      try {
        const inputType = h.closest('[component-id]').getAttribute('input-type');
        h.value = getInitialHiddenValue(inputType);
      } catch (e) {}
    });
  }

  /* ---------- Core reset for a single component ---------- */
  function resetComponentState(componentEl) {
    const map = window.__OptionsBuilder && window.__OptionsBuilder.COMPONENTS ? window.__OptionsBuilder.COMPONENTS : null;
    const componentId = componentEl.getAttribute('component-id');
    const state = map && map.get(componentId) ? map.get(componentId) : null;

    const inputType = state ? state.inputType : (componentEl.getAttribute('input-type') || 'checkbox').toLowerCase();
    const fClass = state ? state.fClass : (componentEl.getAttribute('f-class') || '');
    const lClass = state ? state.lClass : (componentEl.getAttribute('l-class') || '');
    const groupEl = state ? state.groupEl : componentEl.querySelector('[role="group"]');

    let hidden = state && state.hiddenEl ? state.hiddenEl : componentEl.querySelector('input[type="hidden"][cf-json-path]');
    if (!hidden) {
      hidden = document.createElement('input');
      hidden.type = 'hidden';
      const jp = componentEl.getAttribute('json-path') || ('component.' + (componentId || Math.random().toString(36).slice(2)));
      hidden.setAttribute('cf-json-path', jp);
      componentEl.appendChild(hidden);
    }

    // Limpieza de subcomponentes y inputs
    cleanChildComponents(componentEl);

    // Reinicia el valor del hidden input
    const initialVal = getInitialHiddenValue(inputType);
    hidden.value = initialVal;

    // Remueve las clases CSS de los campos
    if (groupEl) {
      groupEl.querySelectorAll('[c-field]').forEach(fe => {
        if (fClass) fe.classList.remove(fClass);
        const lab = fe.querySelector('[c-label]');
        if (lab && lClass) lab.classList.remove(lClass);
      });
    }

    // ðŸš€ NUEVO: GestiÃ³n de dependencias ðŸš€
    // Oculta los elementos dependientes del componente actual
    document.querySelectorAll(`[display-depend="${componentId}"]`).forEach(node => {
        node.style.display = 'none';
        // Limpieza recursiva de los subcomponentes dentro de los elementos ocultos
        cleanChildComponents(node);
    });

    // Remueve data-required de los campos dependientes
    document.querySelectorAll(`[required-depend="${componentId}"]`).forEach(node => {
        node.querySelectorAll('[cf-json-path]').forEach(h => {
            const alwaysReq = String(h.getAttribute('always-required')).trim().toLowerCase() === 'true';
            if (!alwaysReq) {
                h.removeAttribute('data-required');
            }
        });
    });

    // Asegura que el hidden principal recupere su estado 'data-required' si lo tenÃ­a
    const alwaysRequired = componentEl.hasAttribute('always-required');
    if (alwaysRequired) {
      hidden.setAttribute('data-required', '');
    }

    let parsedValue = safeJSONParse(hidden.value, null);
    parsedValue = (inputType === 'checkbox') ? (Array.isArray(parsedValue) ? parsedValue : []) : ((parsedValue && typeof parsedValue === 'object') ? parsedValue : {});

    const detail = {
      componentId: componentId,
      jsonPath: hidden.getAttribute('cf-json-path'),
      type: inputType,
      value: null,
      label: '',
      id: null,
      isChecked: false,
      currentValue: parsedValue
    };

    document.dispatchEvent(new CustomEvent('option-change', { detail }));
    if (inputType === 'checkbox') document.dispatchEvent(new CustomEvent('valid-change-checkbox', { detail }));
    else if (inputType === 'radio') document.dispatchEvent(new CustomEvent('valid-change-radio', { detail }));
  }

  /* ---------- Reset whole form ---------- */
  function resetForm(formEl) {
    document.dispatchEvent(new CustomEvent('cf-loader-on'));
    
    // Primero, encontrar todos los componentes a resetear
    const componentsToReset = formEl ? formEl.querySelectorAll('[component-id]') : document.querySelectorAll('[component-id]');

    componentsToReset.forEach(compEl => {
      resetComponentState(compEl);
    });

    setTimeout(() => {
        document.dispatchEvent(new CustomEvent('cf-loader-off'));
    }, 120);
  }

  /* ---------- Instalar listeners ---------- */
  function install() {
    const reloadEls = document.querySelectorAll('[cf-reload-form]');
    reloadEls.forEach(el => {
      el.addEventListener('click', function (evt) {
        try { evt.preventDefault(); } catch (e) {}
        const form = el.closest('[cf-form-submit]') || null;
        document.dispatchEvent(new CustomEvent('reset-continue-buttons', { detail: form }));
        resetForm(form);
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', install);
  } else {
    install();
  }
})();
</script>